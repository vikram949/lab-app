<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventory Management System - Enhanced</title>
    <!-- PWA Support -->
    <link rel="manifest" href="manifest.json">                                                                               
    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Inventory">
    <link rel="apple-touch-icon" href="images/logo.png">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Logo Setup -->
    <link rel="icon" type="image/png" href="images/logo-32.png">
    <link rel="shortcut icon" type="image/x-icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/logo-32.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <style>
        /* Enhanced Splash Screen Styling */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }

        #toast.detailed-error {
            max-width: 400px !important;
            text-align: left !important;
            padding: 16px 24px !important;
            line-height: 1.4 !important;
        }

        .splash-logo {
            width: 120px;
            height: 120px;
            border-radius: 20px;
            object-fit: contain;
            background: white;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: logoFloat 2s ease-in-out infinite alternate;
        }

        .splash-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            margin-top: 20px;
            text-align: center;
            animation: fadeIn 1s ease-in-out;
        }

        .splash-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
            margin-top: 8px;
            text-align: center;
            animation: fadeIn 1.5s ease-in-out;
        }

        .progress-container {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            margin-top: 30px;
            overflow: hidden;
        }

        .progress-bar {
            width: 0%;
            height: 100%;
            background: white;
            border-radius: 10px;
            animation: progressFill 10s linear forwards;
        }

        .splash-loading-text {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            margin-top: 15px;
            animation: fadeIn 2s ease-in-out;
        }

        .loading-spinner {
            margin-top: 30px;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes logoFloat {
            from {
                transform: translateY(0px);
            }

            to {
                transform: translateY(-10px);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes progressFill {
            from {
                width: 0%;
            }

            to {
                width: 100%;
            }
        }

        .fade-out {
            opacity: 0 !important;
        }

        /* ✅ Clean Table Styling - No Colored Numbers */
        .table-auto {
            font-size: 0.875rem;
        }

        .table-auto th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            padding: 8px !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .table-auto td {
            vertical-align: middle;
            border: 1px solid #e2e8f0;
            padding: 6px !important;
            font-size: 0.75rem;
        }

        .table-auto tbody tr {
            transition: all 0.2s ease;
            height: 50px;
        }

        .table-auto tbody tr:hover {
            background-color: #f8fafc !important;
            transform: scale(1.005);
        }

        .table-auto tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* ✅ SIMPLE NUMBERS - No Background Colors */
        .simple-number {
            font-weight: 600;
            color: #374151;
            padding: 4px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            background: white;
            font-size: 0.875rem;
        }

        /* Action buttons compact */
        .table-auto .action-buttons {
            display: flex;
            gap: 2px;
            justify-content: center;
        }

        .table-auto button {
            padding: 4px !important;
            font-size: 10px !important;
        }

        /* Search Result Highlighting */
        mark {
            background-color: #fef08a;
            padding: 1px 2px;
            border-radius: 2px;
            font-weight: 500;
        }

        .search-indicator {
            background: linear-gradient(45deg, #f59e0b, #f97316);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .toast-enter {
            transform: translateX(100%);
            opacity: 0;
        }

        .toast-show {
            transform: translateX(0);
            opacity: 1;
            transition: all 0.3s ease-in-out;
        }

        .dialog-backdrop {
            backdrop-filter: blur(2px);
        }

        .hover-lift:hover {
            transform: translateY(-2px);
            transition: transform 0.2s ease-in-out;
        }

        .loading {
            opacity: 0.5;
            pointer-events: none;
        }

        .image-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .image-upload-area {
            border: 2px dashed #e5e7eb;
            transition: border-color 0.3s;
            cursor: pointer;
        }

        .image-upload-area:hover {
            border-color: #3b82f6;
            background-color: #f8fafc;
        }

        .profile-image {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #10b981;
        }

        .profile-image-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #3b82f6;
        }

        .category-image {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            object-fit: cover;
            border: 2px solid #e5e7eb;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .app-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: contain;
            background: white;
            padding: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .dashboard-welcome-image {
            width: 100%;
            max-width: 500px;
            height: 300px;
            object-fit: cover;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 3px solid #e5e7eb;
        }

        /* Mobile-like Toast Notification */
        #toast {
            position: fixed !important;
            top: 20px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            background-color: #333 !important;
            color: white !important;
            padding: 12px 24px !important;
            border-radius: 30px !important;
            font-size: 1rem !important;
            z-index: 15000 !important;
            max-width: 90vw !important;
            text-align: center !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3) !important;
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        #toast.show {
            opacity: 1;
        }

        #toast.success {
            background-color: #10b981 !important;
        }

        #toast.error {
            background-color: #ef4444 !important;
        }

        /* Beautiful Confirmation Modal */
        .confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            z-index: 20000;
            max-width: 400px;
            width: 90vw;
            text-align: center;
        }

        .confirm-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 19999;
        }

        .confirm-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 20px;
        }

        .confirm-btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .confirm-btn.cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .confirm-btn.cancel:hover {
            background: #e5e7eb;
        }

        .confirm-btn.delete {
            background: #ef4444;
            color: white;
        }

        .confirm-btn.delete:hover {
            background: #dc2626;
        }

        .confirm-btn.return {
            background: #3b82f6;
            color: white;
        }

        .confirm-btn.return:hover {
            background: #2563eb;
        }

        .confirm-btn.damaged {
            background: #f59e0b;
            color: white;
        }

        .confirm-btn.damaged:hover {
            background: #d97706;
        }

        .action-btn {
            padding: 4px 8px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .edit-btn {
            background: #3b82f6;
            color: white;
        }

        .edit-btn:hover {
            background: #2563eb;
        }

        .delete-btn {
            background: #ef4444;
            color: white;
        }

        .delete-btn:hover {
            background: #dc2626;
        }

        .admin-tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .admin-tab.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background: #f8fafc;
        }

        .admin-tab:hover {
            color: #3b82f6;
            background: #f8fafc;
        }

        /* 3-Dots Menu Styling */
        .dropdown-menu {
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 120px;
            display: none;
        }

        .dropdown-menu.show {
            display: block;
        }

        /* Enhanced checkbox styling */
        .return-item-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #3b82f6;
        }

        .return-item-option input[type="checkbox"]:checked+label {
            background-color: #eff6ff;
            border-color: #3b82f6;
        }

        /* Selection counter styling */
        #selection-counter {
            transition: all 0.3s ease;
        }

        .dropdown-item {
            padding: 8px 16px;
            color: #374151;
            text-decoration: none;
            display: block;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .dropdown-item:hover {
            background-color: #f3f4f6;
        }

        .dropdown-item.delete {
            color: #ef4444;
        }

        .dropdown-item.delete:hover {
            background-color: #fef2f2;
        }

        .property-input {
            margin-bottom: 8px;
        }

        .property-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            margin-left: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .property-value-row {
            transition: all 0.2s ease;
        }

        .property-value-row:hover {
            background-color: #f8fafc;
            border-color: #3b82f6;
        }

        .member-detail-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .member-issued-item {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .return-item-option {
            display: flex;
            align-items: center;
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .return-item-option:hover {
            background-color: #f8fafc;
            border-color: #3b82f6;
        }

        .return-item-option input[type="radio"] {
            margin-right: 12px;
        }

        .low-stock-card {
            transition: all 0.3s ease;
        }

        .low-stock-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* ✅ NEW: Damage reason modal styling */
        .damage-reason-input {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            resize: vertical;
        }

        /* ✅ NEW: Reports styling */
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .report-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        /* ✅ NEW: Audit log styling */
        .audit-entry {
            padding: 12px;
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }

        .audit-entry.create {
            border-left-color: #10b981;
        }

        .audit-entry.update {
            border-left-color: #f59e0b;
        }

        .audit-entry.delete {
            border-left-color: #ef4444;
        }

        .audit-entry.damage {
            border-left-color: #f97316;
        }

        /* ✅ NEW: Export button styling */
        .export-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .export-btn:hover {
            background: linear-gradient(135deg, #059669, #047857);
            transform: translateY(-1px);
        }

        /* ✅ NEW: Reference button styling */
        .reference-btn {
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .reference-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #6d28d9);
            transform: translateY(-1px);
        }

        /* ✅ Damage tab styling */
        .damaged-items-card {
            background: linear-gradient(135deg, #f97316, #ea580c);
            color: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Enhanced Splash Screen -->
    <div id="splash-screen">
        <img src="images/logo.png" alt="Logo" class="splash-logo"
            onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjEyMCIgdmlld0JveD0iMCAwIDEyMCAxMjAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiByeD0iMjAiIGZpbGw9IiMzYjgyZjYiLz4KPHN2ZyB4PSIzMCIgeT0iMzAiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2MCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IndoaXRlIiBzdHJva2Utd2lkdGg9IjIiPgo8cGF0aCBkPSJtMyA5IDkgOS05LTl6TTIxIDlsLTkgOSA5LTl6Ii8+CjxwYXRoIGQ9Im0xNSAxNS05LTktOSA5Ii8+Cjwvc3ZnPgo8L3N2Zz4='"
            > <h1 class="splash-title">Inventory System</h1>
        <p class="splash-subtitle">Advanced Management Solution</p>
        <div class="progress-container">
            <div class="progress-bar" id="splash-progress"></div>
        </div>
        <p class="splash-loading-text">Loading your workspace...</p>
    </div>

    <!-- Loading overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center gap-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600"></div>
                <span>Loading...</span>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-backdrop" class="confirm-backdrop hidden"></div>
    <div id="confirm-modal" class="confirm-modal hidden">
        <div class="text-6xl mb-4">⚠️</div>
        <div id="confirm-message" class="text-lg font-medium text-gray-800 mb-4"></div>
        <div class="confirm-buttons">
            <button id="confirm-cancel" class="confirm-btn cancel">Cancel</button>
            <button id="confirm-delete" class="confirm-btn delete">Delete</button>
        </div>
    </div>

    <!-- Login/Signup Modal -->
    <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-8 rounded-lg w-96 max-w-full mx-4">
            <h2 class="text-2xl font-bold mb-6 text-center">Inventory System Login</h2>

            <div id="login-form">
                <div class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="w-full p-3 border rounded-lg" />
                    <input type="password" id="login-password" placeholder="Password"
                        class="w-full p-3 border rounded-lg" />
                    <button onclick="signIn()" class="w-full bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600">
                        Sign In
                    </button>
                </div>

                <div class="mt-4 text-center space-y-2">
                    <p class="text-gray-600">Need an account?</p>
                    <button onclick="showSignUp()" class="text-blue-500 hover:underline">Sign Up</button>
                    <div class="mt-2">
                        <button onclick="resendVerificationEmail()" class="text-sm text-green-500 hover:underline">
                            Resend Verification Email
                        </button>
                    </div>
                </div>
            </div>

            <div id="signup-form" class="hidden">
                <div class="space-y-4">
                    <input type="email" id="signup-email" placeholder="Email" class="w-full p-3 border rounded-lg" />
                    <input type="password" id="signup-password" placeholder="Password (6+ characters)"
                        class="w-full p-3 border rounded-lg" />
                    <input type="password" id="signup-confirm" placeholder="Confirm Password"
                        class="w-full p-3 border rounded-lg" />
                    <button onclick="signUp()"
                        class="w-full bg-green-500 text-white py-3 rounded-lg hover:bg-green-600">
                        Sign Up
                    </button>
                </div>

                <div class="mt-4 text-center">
                    <p class="text-gray-600">Already have an account?</p>
                    <button onclick="showSignIn()" class="text-blue-500 hover:underline">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="app" class="flex min-h-screen hidden">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-800 text-white min-h-screen p-4">
            <div class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-3">
                    <img src="images/logo.png" alt="Logo" class="app-logo" onerror="this.style.display='none'">
                    <h1 class="text-lg font-bold">Inventory System</h1>
                </div>
                <button onclick="signOut()" class="logout-btn" title="Logout">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span>Logout</span>
                </button>
            </div>
            <nav>
                <ul class="space-y-2">
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="dashboard">
                            <i data-lucide="bar-chart-3"></i>
                            Dashboard
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="members">
                            <i data-lucide="users"></i>
                            Members
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="components">
                            <i data-lucide="package"></i>
                            Components
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="admin">
                            <i data-lucide="settings"></i>
                            Admin
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="reports">
                            <i data-lucide="file-text"></i>
                            Reports & Analytics
                        </button>
                    </li>
                    <li>
                        <button
                            class="nav-btn w-full flex items-center gap-3 p-3 rounded-lg transition-colors hover:bg-gray-700"
                            data-section="audit">
                            <i data-lucide="activity"></i>
                            Audit Log
                        </button>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Dashboard Section -->
            <div id="dashboard-section" class="section">
                <h1 class="text-3xl font-bold mb-8">Dashboard</h1>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow hover-lift">
                        <h3 class="text-lg font-semibold text-gray-700">Total Members</h3>
                        <p class="text-3xl font-bold text-blue-600" id="total-members">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover-lift">
                        <h3 class="text-lg font-semibold text-gray-700">Total Items</h3>
                        <p class="text-3xl font-bold text-green-600" id="total-items">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover-lift">
                        <h3 class="text-lg font-semibold text-gray-700">Issued quantity </h3>
                        <p class="text-3xl font-bold text-orange-600" id="issued-items">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover-lift">
                        <h3 class="text-lg font-semibold text-gray-700">Available</h3>
                        <p class="text-3xl font-bold text-purple-600" id="available-items">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover-lift cursor-pointer transition-all hover:scale-105 low-stock-card"
                        onclick="showLowStockPage()">
                        <h3 class="text-lg font-semibold text-red-700">Low Stock Items</h3>
                        <p class="text-3xl font-bold text-red-600" id="low-stock-items">0</p>
                        <p class="text-xs text-gray-500 mt-1">Click to view details</p>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow hover-lift cursor-pointer transition-all hover:scale-105"
                        onclick="showDamagedPage()">
                        <h3 class="text-lg font-semibold text-orange-700">Damaged Items</h3>
                        <p class="text-3xl font-bold text-orange-600" id="damaged-items">0</p>
                        <p class="text-xs text-gray-500 mt-1">Click to view details</p>
                    </div>
                </div>

                <!-- Welcome Section -->
                <div class="bg-white rounded-lg shadow p-8 text-center">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">Welcome to Advanced Inventory Management</h2>
                    <p class="text-gray-600 mb-6">Manage your components, track members, monitor inventory with real-time updates & comprehensive analytics</p>

                    <img src="images/dashboard-welcome.jpg" alt="Inventory Management"
                        class="dashboard-welcome-image mx-auto"
                        onerror="this.src='https://t4.ftcdn.net/jpg/05/81/23/05/360_F_581230590_7bgkoYcnWN2qglejxuc9CswekwsDopMo.jpg'">

                    <div class="mt-6 flex justify-center gap-4 flex-wrap">
                        <button onclick="setActiveSection('members')"
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                            Manage Members
                        </button>
                        <button onclick="setActiveSection('components')"
                            class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                            <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                            Manage Components
                        </button>
                        <button onclick="setActiveSection('reports')"
                            class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600 transition-colors">
                            <i data-lucide="bar-chart" class="w-4 h-4 inline mr-2"></i>
                            View Analytics
                        </button>
                        <button onclick="exportAllData()"
                            class="export-btn">
                            <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                            Export Data
                        </button>
                    </div>
                </div>
            </div>

            <!-- ✅ NEW: Reports & Analytics Section -->
            <div id="reports-section" class="section hidden">
                <h1 class="text-3xl font-bold mb-8">Reports & Analytics</h1>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <!-- Export Options -->
                    <div class="report-card">
                        <h3 class="text-lg font-semibold mb-4 text-blue-600">
                            <i data-lucide="download" class="w-5 h-5 inline mr-2"></i>
                            Export Data
                        </h3>
                        <div class="space-y-3">
                            <button onclick="exportMembers()" class="w-full export-btn">
                                <i data-lucide="users" class="w-4 h-4 inline mr-2"></i>
                                Export Members
                            </button>
                            <button onclick="exportItems()" class="w-full export-btn">
                                <i data-lucide="package" class="w-4 h-4 inline mr-2"></i>
                                Export Items
                            </button>
                            <button onclick="exportIssueHistory()" class="w-full export-btn">
                                <i data-lucide="history" class="w-4 h-4 inline mr-2"></i>
                                Export Issue History
                            </button>
                            <button onclick="exportAllData()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white px-4 py-2 rounded hover:from-purple-600 hover:to-indigo-700">
                                <i data-lucide="database" class="w-4 h-4 inline mr-2"></i>
                                Export All Data
                            </button>
                        </div>
                    </div>

                    <!-- Quick Stats -->
                    <div class="report-card">
                        <h3 class="text-lg font-semibold mb-4 text-green-600">
                            <i data-lucide="trending-up" class="w-5 h-5 inline mr-2"></i>
                            Quick Analytics
                        </h3>
                        <div class="space-y-2" id="quick-analytics">
                               <!-- <div class="flex justify-between">
        <span>Total Inventory Value:</span> -->
        <!-- <span class="font-semibold" id="total-value">Loading...</span> -->
    <!-- </div> --> 
                           
                            <div class="flex justify-between">
                                <span>Most Active Member:</span>
                                <span class="font-semibold" id="most-active-member">Loading...</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Most Issued Item:</span>
                                <span class="font-semibold" id="most-issued-item">Loading...</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Avg Issue Duration:</span>
                                <span class="font-semibold" id="avg-duration">Loading...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Category Analysis -->
                    <div class="report-card">
                        <h3 class="text-lg font-semibold mb-4 text-orange-600">
                            <i data-lucide="pie-chart" class="w-5 h-5 inline mr-2"></i>
                            Category Breakdown
                        </h3>
                        <div id="category-breakdown">
                            Loading category analysis...
                        </div>
                    </div>
                </div>

                <!-- Detailed Reports -->
                <div class="bg-white rounded-lg shadow p-6">
                    <h2 class="text-xl font-bold mb-6">Detailed Reports</h2>
                    
                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Low Stock Report -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-red-600">Low Stock Alert</h3>
                            <div id="low-stock-report" class="space-y-2">
                                Loading low stock items...
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4 text-blue-600">Recent Activity</h3>
                            <div id="recent-activity" class="space-y-2">
                                Loading recent activity...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ NEW: Audit Log Section -->
            <div id="audit-section" class="section hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h1 class="text-3xl font-bold">Audit Log</h1>
                        <div class="flex gap-3">
                            <button onclick="clearAuditLog()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                Clear Log
                            </button>
                            <button onclick="exportAuditLog()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Export Log
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <input type="text" placeholder="Search audit log..." id="search-audit"
                            class="w-full p-3 border rounded-lg" oninput="searchAuditLog()">
                    </div>

                    <div id="audit-log-container" class="max-h-96 overflow-y-auto">
                        <p class="text-gray-500 text-center py-8">Loading audit entries...</p>
                    </div>
                </div>
            </div>

            <!-- Low Stock Items Section -->
            <div id="low-stock-section" class="section hidden">
                <button onclick="setActiveSection('dashboard')" class="mb-4 text-blue-500 hover:underline">
                    ← Back to Dashboard
                </button>

                <div class="bg-white rounded-lg shadow p-6">
                    <h1 class="text-3xl font-bold mb-6 text-red-600">Low Stock Items</h1>
                    <p class="text-gray-600 mb-6">Items that are running low on quantity (≤ 5 units available)</p>

                    <div id="low-stock-content">
                        <!-- Low stock items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- ✅ NEW: Damaged Items Section -->
            <div id="damaged-section" class="section hidden">
                <button onclick="setActiveSection('dashboard')" class="mb-4 text-blue-500 hover:underline">
                    ← Back to Dashboard
                </button>

                <div class="damaged-items-card">
                    <div class="flex items-center mb-4">
                        <i data-lucide="alert-triangle" class="w-8 h-8 mr-3"></i>
                        <div>
                            <h1 class="text-3xl font-bold">Damaged Items</h1>
                            <p class="opacity-90">Items that have been marked as damaged or lost</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow p-6">
                    <div id="damaged-content">
                        <!-- Damaged items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Member Detail Section -->
            <div id="member-detail-section" class="section hidden">
                <button onclick="setActiveSection('members')" class="mb-4 text-blue-500 hover:underline">
                    ← Back to Members
                </button>

                <div id="member-detail-content">
                    <!-- Member detail content will be populated here -->
                </div>
            </div>

            <!-- Members Section -->
            <div id="members-section" class="section hidden">
                <div class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Members</h2>
                        <div class="flex gap-3">
                            <button onclick="exportMembers()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Export
                            </button>
                            <button onclick="openDialog('addMember')"
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-600">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Add Member
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <input type="text" placeholder="Search members..." id="search-members"
                            class="w-full p-3 border rounded-lg" oninput="searchMembers()">
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full table-auto">
                            <thead>
                                <tr class="bg-gray-50">
                                    <th class="p-3 text-left">Photo</th>
                                    <th class="p-3 text-left">Name</th>
                                    <th class="p-3 text-left">Batch</th>
                                    <th class="p-3 text-left">Branch</th>
                                    <th class="p-3 text-left">Year</th>
                                    <th class="p-3 text-left">Contact</th>
                                    <th class="p-3 text-left">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="members-table-body">
                                <tr>
                                    <td colspan="7" class="p-3 text-center">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Components Section -->
            <div id="components-section" class="section hidden">
                <!-- Categories View -->
                <div id="categories-view" class="bg-white rounded-lg shadow p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Components</h2>
                        <div class="flex gap-3">
                            <button onclick="exportItems()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Export Items
                            </button>
                            <button onclick="openDialog('addCategory')"
                                class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-600">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Add Category
                            </button>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex space-x-4 mb-6 border-b">
                        <button class="tab-btn pb-2 px-1 border-b-2 border-blue-500 text-blue-600 font-semibold"
                            data-tab="consumable">
                            Consumable
                        </button>
                        <button class="tab-btn pb-2 px-1 text-gray-500" data-tab="nonConsumable">
                            Non-Consumable
                        </button>
                    </div>

                    <div class="mb-4">
                        <input type="text" placeholder="Search categories or properties..." id="search-categories"
                            class="w-full p-3 border rounded-lg" oninput="searchCategories()">
                        <p class="text-xs text-gray-500 mt-1">Search by category name, description, or properties (e.g.,
                            "voltage", "resistance")</p>
                    </div>

                    <!-- Categories Grid -->
                    <div id="categories-grid" class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="col-span-full text-center p-8">Loading categories...</div>
                    </div>
                </div>

                <!-- Items View - TABLE FORMAT -->
                <div id="items-view" class="bg-white rounded-lg shadow p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <button onclick="showCategoriesView()" class="text-blue-500 hover:underline mb-2">
                                ← Back to Categories
                            </button>
                            <h2 id="category-title" class="text-2xl font-bold"></h2>
                        </div>
                        <div class="flex gap-3">
                            <!-- ✅ NEW: Reference Button -->
                            <button onclick="openDialog('itemReference')" class="reference-btn">
                                <i data-lucide="book-open" class="w-4 h-4"></i>
                                Reference
                            </button>
                            <button onclick="exportCategoryItems()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4"></i>
                                Export
                            </button>
                            <button onclick="openDialog('addItem')"
                                class="bg-green-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-600">
                                <i data-lucide="plus" class="w-5 h-5"></i>
                                Add Item
                            </button>
                        </div>
                    </div>

                    <div class="mb-4">
                        <input type="text" placeholder="Search items globally..." id="search-items"
                            class="w-full p-3 border rounded-lg" oninput="searchItems()" />
                        <p class="text-xs text-gray-500 mt-1">Search by name, properties, or values</p>
                    </div>

                    <!-- ✅ FIXED TABLE FORMAT - Clean Numbers -->
                    <div class="overflow-x-auto">
                        <table class="w-full table-auto border-collapse">
                            <thead id="items-table-head">
                                <tr class="bg-gray-50 border-b">
                                    <th class="p-3 text-left border">Image</th>
                                    <th class="p-3 text-left border">Name</th>
                                    <!-- Dynamic property columns will be added here -->
                                    <th class="p-3 text-left border">Available</th>
                                    <th class="p-3 text-left border">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="items-table-body">
                                <tr>
                                    <td colspan="5" class="p-3 text-center">Loading items...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Item Detail View -->
                <div id="item-detail-view" class="bg-white rounded-lg shadow p-6 hidden">
                    <button onclick="showItemsView()" class="mb-4 text-blue-500 hover:underline">
                        ← Back to Items
                    </button>

                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <div id="item-image-container"
                                class="w-32 h-32 mb-4 rounded-lg border flex items-center justify-center bg-gray-50">
                                <span class="text-6xl">🔌</span>
                            </div>
                            <h2 id="item-name" class="text-2xl font-bold mb-2"></h2>
                            <div class="space-y-2 text-gray-600">
                                <p>Available: <span id="item-available" class="font-semibold text-green-600"></span></p>
                                <p>Total: <span id="item-total" class="font-semibold"></span></p>
                                <p>Property: <span id="item-property" class="font-medium text-blue-600"></span></p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-4">Issued To:</h3>
                            <div id="issued-list" class="space-y-2">
                                <p class="text-gray-500 text-center py-4">Loading...</p>
                            </div>

                            <div class="mt-4 space-y-2">
                                <button onclick="openDialog('issueItem')"
                                    class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                    Issue Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ✅ ENHANCED: Admin Section with Damaged Tab -->
            <div id="admin-section" class="section hidden">
                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-2xl font-bold mb-6">Admin Panel</h2>

                        <!-- ✅ ENHANCED: Admin Tabs with Damaged -->
                        <div class="flex space-x-4 mb-6 border-b overflow-x-auto">
                            <button class="admin-tab active" data-admin-tab="current"
                                onclick="setActiveAdminTab('current')">
                                <i data-lucide="clock" class="w-4 h-4 inline mr-2"></i>
                                Current Issues
                            </button>
                            <button class="admin-tab" data-admin-tab="history" onclick="setActiveAdminTab('history')">
                                <i data-lucide="history" class="w-4 h-4 inline mr-2"></i>
                                History
                            </button>
                            <button class="admin-tab" data-admin-tab="permanent"
                                onclick="setActiveAdminTab('permanent')">
                                <i data-lucide="lock" class="w-4 h-4 inline mr-2"></i>
                                Permanent Issues
                            </button>
                            <button class="admin-tab" data-admin-tab="damaged" onclick="setActiveAdminTab('damaged')">
                                <i data-lucide="alert-triangle" class="w-4 h-4 inline mr-2"></i>
                                Damaged
                            </button>
                        </div>

                        <!-- Current Issues Tab Content -->
                        <div id="current-issues-content" class="admin-tab-content">
                            <h3 class="text-lg font-semibold mb-4 text-green-600">Currently Issued Items</h3>

                            <div class="mb-4">
                                <input type="text" placeholder="Search issues..." id="search-issues"
                                    class="w-full p-3 border rounded-lg" oninput="searchIssues()">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="p-3 text-left">Item Image</th>
                                            <th class="p-3 text-left">Item Name</th>
                                            <th class="p-3 text-left">Member</th>
                                            <th class="p-3 text-left">Member Photo</th>
                                            <th class="p-3 text-left">Branch</th>
                                            <th class="p-3 text-left">Quantity</th>
                                            <th class="p-3 text-left">Issue Date</th>
                                            <th class="p-3 text-left">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="current-issues-table">
                                        <tr>
                                            <td colspan="8" class="p-3 text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- History Tab Content -->
                        <div id="history-content" class="admin-tab-content hidden">
                            <h3 class="text-lg font-semibold mb-4 text-blue-600">Returned Items History</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead>
                                        <tr class="bg-gray-50">
                                            <th class="p-3 text-left">Item Image</th>
                                            <th class="p-3 text-left">Item Name</th>
                                            <th class="p-3 text-left">Member</th>
                                            <th class="p-3 text-left">Member Photo</th>
                                            <th class="p-3 text-left">Branch</th>
                                            <th class="p-3 text-left">Quantity</th>
                                            <th class="p-3 text-left">Issue Date</th>
                                            <th class="p-3 text-left">Return Date</th>
                                            <th class="p-3 text-left">Duration</th>
                                        </tr>
                                    </thead>
                                    <tbody id="history-table">
                                        <tr>
                                            <td colspan="9" class="p-3 text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Permanent Issues Tab Content -->
                        <div id="permanent-issues-content" class="admin-tab-content hidden">
                            <div class="flex items-center mb-4">
                                <div class="bg-red-100 border border-red-400 rounded-lg p-4 w-full">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i data-lucide="alert-triangle" class="w-5 h-5 text-red-600"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-lg font-semibold text-red-800">Permanently Issued Items</h3>
                                            <p class="text-sm text-red-700">Items that will not be returned</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <input type="text" placeholder="Search permanent issues..." id="search-permanent"
                                    class="w-full p-3 border rounded-lg" oninput="searchPermanentIssues()">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead>
                                        <tr class="bg-red-50">
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Item Image</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Item Name</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Member</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Member Photo</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Branch</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Quantity</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Issue Date</th>
                                            <th
                                                class="p-3 text-left bg-gradient-to-r from-red-500 to-red-600 text-white">
                                                Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="permanent-issues-table">
                                        <tr>
                                            <td colspan="8" class="p-3 text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- ✅ NEW: Damaged Tab Content -->
                        <div id="damaged-issues-content" class="admin-tab-content hidden">
                            <div class="flex items-center mb-4">
                                <div class="bg-orange-100 border border-orange-400 rounded-lg p-4 w-full">
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0">
                                            <i data-lucide="alert-triangle" class="w-5 h-5 text-orange-600"></i>
                                        </div>
                                        <div class="ml-3">
                                            <h3 class="text-lg font-semibold text-orange-800">Damaged/Lost Items</h3>
                                            <p class="text-sm text-orange-700">Items that have been damaged or lost</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <input type="text" placeholder="Search damaged items..." id="search-damaged"
                                    class="w-full p-3 border rounded-lg" oninput="searchDamagedIssues()">
                            </div>

                            <div class="overflow-x-auto">
                                <table class="w-full table-auto">
                                    <thead>
                                        <tr class="bg-orange-50">
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Item Image</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Item Name</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Member</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Branch</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Quantity</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Issue Date</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Damage Date</th>
                                            <th class="p-3 text-left bg-gradient-to-r from-orange-500 to-orange-600 text-white">Reason</th>
                                        </tr>
                                    </thead>
                                    <tbody id="damaged-issues-table">
                                        <tr>
                                            <td colspan="8" class="p-3 text-center">Loading...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dialog Modal -->
    <div id="dialog-backdrop"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden dialog-backdrop">
        <div class="bg-white p-6 rounded-lg w-96 max-w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="dialog-title" class="text-lg font-semibold">Dialog Title</h3>
                <button onclick="closeDialog()">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>

            <div id="dialog-content">
                <!-- Dialog content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden">
        <span id="toast-message">Success message</span>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ffqdvcxyxtunoanrfdee.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZmcWR2Y3h5eHR1bm9hbnJmZGVlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1Mzg1OTAsImV4cCI6MjA3MTExNDU5MH0.q1WtNtTryPSq1hXlTGilUb01dEYZbm1ZHUDvwQ8cuhc';

        // Initialize Supabase client
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global State
        let activeSection = 'dashboard';
        let activeTab = 'consumable';
        let activeAdminTab = 'current';
        let selectedCategory = null;
        let selectedItem = null;
        let selectedMember = null;
        let currentUser = null;
        let subscriptions = [];
        let isInitialized = false;
        let authListenerSetup = false;

        // ✅ NEW: Audit Log Storage
        let auditLog = JSON.parse(localStorage.getItem('inventoryAuditLog')) || [];

        // ✅ NEW: Add Audit Entry
        function addAuditEntry(action, details, userId = null) {
            const entry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                action: action, // 'create', 'update', 'delete', 'issue', 'return', 'damage'
                details: details,
                user: userId || currentUser?.email || 'System',
                ip: 'Browser Session' // Could be enhanced with actual IP
            };
            
            auditLog.unshift(entry); // Add to beginning
            
            // Keep only last 1000 entries
            if (auditLog.length > 1000) {
                auditLog = auditLog.slice(0, 1000);
            }
            
            localStorage.setItem('inventoryAuditLog', JSON.stringify(auditLog));
            
            // Real-time update if audit section is active
            if (activeSection === 'audit') {
                populateAuditLog();
            }
        }

        // ✅ BULLETPROOF: Advanced Calculation Fixer
        async function fixItemCalculations() {
            try {
                console.log('🔧 Starting ADVANCED calculation fix...');
                showToast('🔧 Deep fixing all calculations...', 'success');
                showLoading(true);

                const { data: items, error: itemsError } = await supabaseClient
                    .from('items')
                    .select(`*, categories(name)`);

                if (itemsError) throw itemsError;

                const { data: allIssuedItems, error: issuedError } = await supabaseClient
                    .from('issued_items')
                    .select('item_id, quantity, status');

                if (issuedError) throw issuedError;

                let fixedCount = 0;
                let totalChecked = 0;

                for (const item of items) {
                    totalChecked++;
                    console.log(`🔍 [${totalChecked}/${items.length}] Checking: ${item.name}`);

                    const itemIssued = allIssuedItems
                        .filter(issued => issued.item_id === item.id && (issued.status === 'issued' || issued.status === 'permanent'))
                        .reduce((sum, issued) => sum + (issued.quantity || 0), 0);

                    const correctAvailable = Math.max(0, item.total - itemIssued);

                    const needsFix = (
                        item.available !== correctAvailable ||
                        item.available > item.total ||
                        item.available < 0 ||
                        (item.total - item.available) !== itemIssued
                    );

                    if (needsFix) {
                        console.log(`🔧 FIXING: ${item.name}`);

                        const { error: updateError } = await supabaseClient
                            .from('items')
                            .update({
                                available: correctAvailable,
                                last_calculated: new Date().toISOString()
                            })
                            .eq('id', item.id);

                        if (updateError) {
                            console.error(`❌ Failed to fix ${item.name}:`, updateError);
                        } else {
                            console.log(`✅ Fixed ${item.name}`);
                            fixedCount++;
                        }
                    } else {
                        console.log(`✅ ${item.name} is PERFECT`);
                    }
                }

                console.log('✅ CALCULATION FIX COMPLETED!');
                await updateStats();

                const resultMessage = `✅ PERFECT! Fixed ${fixedCount}/${totalChecked} items. All calculations verified!`;
                showToast(resultMessage, 'success');

                addAuditEntry('system', `Auto-fix completed: ${fixedCount}/${totalChecked} items fixed`);

                return { fixedCount, totalChecked };

            } catch (error) {
                console.error('💥 CRITICAL ERROR in calculation fix:', error);
                showToast('💥 Calculation fix failed: ' + error.message, 'error');
                return { error: error.message };
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Enhanced Error Messaging Function
        function showDetailedError(title, details = '') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            if (toast && toastMessage) {
                const fullMessage = details ? `${title}<br><br><small>${details}</small>` : title;

                toastMessage.innerHTML = fullMessage;
                toast.classList.remove('hidden', 'show', 'success', 'error');
                toast.classList.add('error', 'show', 'detailed-error');

                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.classList.add('hidden');
                        toast.classList.remove('detailed-error');
                    }, 300);
                }, 6000);
            }

            console.error(` ${title}${details ? '\nDetails: ' + details : ''}`);
        }

        // ✅ ENHANCED Real-time Subscriptions Setup - REAL UPDATES
        
// setupRealtimeSubscriptions function में यह code add करें:

async function setupRealtimeSubscriptions() {
    try {
        console.log(' Setting up ENHANCED real-time subscriptions...');
        cleanupSubscriptions();

        // Items table changes - IMMEDIATE REFRESH
        const itemsSubscription = supabaseClient
            .channel('items-changes-enhanced')
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'items' },
                (payload) => {
                    console.log(' Items updated:', payload.eventType);
                    addAuditEntry('update', `Item ${payload.eventType}: ${payload.new?.name || payload.old?.name}`);
                    
                    // ✅ REPORTS REAL-TIME UPDATE
                    if (activeSection === 'reports') {
                        setTimeout(() => updateReportsData(), 500);
                    }
                    
                    if (activeSection === 'components' && selectedCategory) {
                        setTimeout(() => populateItems(selectedCategory.id), 100);
                    }
                    setTimeout(() => updateStats(), 200);
                })
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'issued_items' },
                (payload) => {
                    console.log(' Issued items updated:', payload.eventType);
                    addAuditEntry('update', `Issue ${payload.eventType}: ${payload.new?.status || payload.old?.status}`);
                    
                    // ✅ REPORTS REAL-TIME UPDATE
                    if (activeSection === 'reports') {
                        setTimeout(() => updateReportsData(), 500);
                    }
                    
                    if (activeSection === 'components' && selectedCategory) {
                        setTimeout(() => populateItems(selectedCategory.id), 100);
                    }
                    if (activeSection === 'admin') {
                        setTimeout(() => populateCurrentIssuesTable(), 150);
                        setTimeout(() => populateHistoryTable(), 200);
                        setTimeout(() => populatePermanentIssuesTable(), 250);
                        setTimeout(() => populateDamagedIssuesTable(), 300);
                    }
                    setTimeout(() => updateStats(), 350);
                })
            .subscribe();

        // Members table changes
        const membersSubscription = supabaseClient
            .channel('members-changes-enhanced')
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'members' },
                (payload) => {
                    console.log('👥 Members updated:', payload.eventType);
                    addAuditEntry('update', `Member ${payload.eventType}: ${payload.new?.name || payload.old?.name}`);
                    
                    // ✅ REPORTS REAL-TIME UPDATE
                    if (activeSection === 'reports') {
                        setTimeout(() => updateReportsData(), 300);
                    }
                    
                    setTimeout(() => updateStats(), 100);
                    if (activeSection === 'members') {
                        setTimeout(() => populateMembersTable(), 150);
                    }
                })
            .subscribe();

        // Categories changes
        const categoriesSubscription = supabaseClient
            .channel('categories-changes-enhanced')
            .on('postgres_changes',
                { event: '*', schema: 'public', table: 'categories' },
                (payload) => {
                    console.log(' Categories updated:', payload.eventType);
                    addAuditEntry('update', `Category ${payload.eventType}: ${payload.new?.name || payload.old?.name}`);
                    
                    // ✅ REPORTS REAL-TIME UPDATE
                    if (activeSection === 'reports') {
                        setTimeout(() => updateReportsData(), 300);
                    }
                    
                    if (activeSection === 'components') {
                        setTimeout(() => populateCategories(), 100);
                    }
                })
            .subscribe();

        subscriptions.push(itemsSubscription, membersSubscription, categoriesSubscription);
        console.log(' ENHANCED Real-time subscriptions setup completed with Reports updates');

    } catch (error) {
        console.error(' Real-time setup failed:', error);
        showToast('Real-time updates may not work properly', 'error');
    }
}


        // ✅ FIXED: Cleanup Subscriptions
        function cleanupSubscriptions() {
            console.log(' Cleaning up subscriptions...');
            subscriptions.forEach(sub => {
                if (sub && sub.unsubscribe) {
                    sub.unsubscribe();
                }
            });
            subscriptions = [];
        }

        // Enhanced Splash Screen Functions
        function hideSplashScreen() {
            const splash = document.getElementById('splash-screen');
            splash.classList.add('fade-out');
            setTimeout(() => {
                splash.style.display = 'none';
                checkAuthAndShowApp();
            }, 500);
        }

        async function checkAuthAndShowApp() {
            try {
                const { data: { user } } = await supabaseClient.auth.getUser();
                if (user) {
                    currentUser = user;
                    showMainApp();
                    await init();
                } else {
                    showAuthModal();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAuthModal();
            }
        }

        function showSplashAndInit() {
            const splash = document.getElementById('splash-screen');
            splash.style.display = 'flex';
            setTimeout(() => {
                hideSplashScreen();
            }, 3000);
        }

        // ✅ COMPLETE FIXED: Delete Item Function
        async function deleteItem(itemId) {
            try {
                console.log(` Attempting to delete item ID: ${itemId}`);

                if (!itemId || isNaN(itemId)) {
                    showToast('Invalid item ID', 'error');
                    return;
                }

                const { data: itemData, error: itemFetchError } = await supabaseClient
                    .from('items')
                    .select('name, available, total')
                    .eq('id', itemId)
                    .single();

                if (itemFetchError || !itemData) {
                    showToast('Item not found', 'error');
                    return;
                }

                const { data: issuedItems, error: checkError } = await supabaseClient
                    .from('issued_items')
                    .select('id, quantity, members(name)')
                    .eq('item_id', itemId)
                    .in('status', ['issued', 'permanent']);

                if (checkError) {
                    showToast('Error checking item status', 'error');
                    return;
                }

                if (issuedItems && issuedItems.length > 0) {
                    const totalIssued = issuedItems.reduce((sum, item) => sum + item.quantity, 0);
                    const membersList = issuedItems.map(item => item.members?.name || 'Unknown').join(', ');

                    showDetailedError(
                        ` Cannot delete "${itemData.name}"`,
                        `${totalIssued} units are currently issued to: ${membersList}.\n\nPlease return all items first, then try deleting.`
                    );
                    return;
                }

                const confirmed = await showConfirmDialog(
                    `Are you sure you want to delete "${itemData.name}"?\n\nTotal Quantity: ${itemData.total}\nAvailable: ${itemData.available}\n\nThis action cannot be undone.`
                );

                if (!confirmed) return;

                showLoading(true);

                const { error: deleteError } = await supabaseClient
                    .from('items')
                    .delete()
                    .eq('id', itemId);

                if (deleteError) throw deleteError;

                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });

                if (selectedCategory) {
                    await populateItems(selectedCategory.id);
                } else {
                    await populateCategories();
                }

                await updateStats();
                showToast(` "${itemData.name}" deleted successfully`);
                addAuditEntry('delete', `Item deleted: ${itemData.name}`);

            } catch (error) {
                console.error(' Critical error in deleteItem:', error);
                showDetailedError(' Delete failed', `Database error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Delete Member Function
        async function deleteMember(memberId) {
            try {
                const confirmed = await showConfirmDialog('Are you sure you want to delete this member? This action cannot be undone.');
                if (!confirmed) return;

                showLoading(true);

                const { data: issuedItems, error: checkError } = await supabaseClient
                    .from('issued_items')
                    .select('id')
                    .eq('member_id', memberId)
                    .in('status', ['issued', 'permanent']);

                if (checkError) throw checkError;

                if (issuedItems && issuedItems.length > 0) {
                    showToast('Cannot delete member with issued items. Please return all items first.', 'error');
                    return;
                }

                const { data: memberData } = await supabaseClient
                    .from('members')
                    .select('name')
                    .eq('id', memberId)
                    .single();

                const { error } = await supabaseClient
                    .from('members')
                    .delete()
                    .eq('id', memberId);

                if (error) throw error;

                populateMembersTable();
                updateStats();
                showToast('Member deleted successfully');
                addAuditEntry('delete', `Member deleted: ${memberData?.name || 'Unknown'}`);

            } catch (error) {
                console.error('Error deleting member:', error);
                showToast('Error deleting member: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Delete Category Function
        async function deleteCategory(categoryId) {
            try {
                const confirmed = await showConfirmDialog('Are you sure you want to delete this category? This will also delete all items in this category.');
                if (!confirmed) return;

                showLoading(true);

                const { data: items, error: checkError } = await supabaseClient
                    .from('items')
                    .select('id')
                    .eq('category_id', categoryId);

                if (checkError) throw checkError;

                const { data: categoryData } = await supabaseClient
                    .from('categories')
                    .select('name')
                    .eq('id', categoryId)
                    .single();

                if (items && items.length > 0) {
                    const confirmed2 = await showConfirmDialog(`This category contains ${items.length} items. Delete anyway? This cannot be undone.`);
                    if (!confirmed2) return;

                    const { error: itemsError } = await supabaseClient
                        .from('items')
                        .delete()
                        .eq('category_id', categoryId);

                    if (itemsError) throw itemsError;
                }

                const { error } = await supabaseClient
                    .from('categories')
                    .delete()
                    .eq('id', categoryId);

                if (error) throw error;

                populateCategories();
                updateStats();
                showToast('Category deleted successfully');
                addAuditEntry('delete', `Category deleted: ${categoryData?.name || 'Unknown'} (with ${items?.length || 0} items)`);

            } catch (error) {
                console.error('Error deleting category:', error);
                showToast('Error deleting category: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Toggle Menu Function
        function toggleMenu(menuId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            const menu = document.getElementById(menuId);
            const allMenus = document.querySelectorAll('.dropdown-menu');

            allMenus.forEach(m => {
                if (m.id !== menuId) {
                    m.classList.remove('show');
                }
            });

            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // ✅ FIXED: Click Outside to Close Menus
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.dropdown-menu') &&
                !event.target.closest('[onclick*="toggleMenu"]') &&
                !event.target.closest('button[onclick*="toggleMenu"]')) {

                document.querySelectorAll('.dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // ✅ FIXED: Update Stats Function
        async function updateStats() {
            try {
                console.log(' Updating stats calculation...');

                const members = await fetchMembers();
                const items = await fetchItems();

                const { data: currentIssues, error: issueError } = await supabaseClient
                    .from('issued_items')
                    .select('quantity')
                    .in('status', ['issued', 'permanent']);

                const { data: damagedItems, error: damagedError } = await supabaseClient
                    .from('issued_items')
                    .select('quantity')
                    .eq('status', 'damaged');

                if (issueError) {
                    console.error('Error fetching issued items:', issueError);
                }

                let totalQuantity = 0;
                let availableQuantity = 0;
                let lowStockItems = 0;
                let issuedQuantity = 0;
                let damagedQuantity = 0;

                items.forEach(item => {
                    totalQuantity += item.total || 0;
                    availableQuantity += item.available || 0;
                    if (item.available <= 5) {
                        lowStockItems++;
                    }
                });

                if (currentIssues && currentIssues.length > 0) {
                    issuedQuantity = currentIssues.reduce((sum, issue) => sum + (issue.quantity || 0), 0);
                }

                if (damagedItems && damagedItems.length > 0) {
                    damagedQuantity = damagedItems.length; // Count of damaged items
                }

                const totalMembersEl = document.getElementById('total-members');
                const totalItemsEl = document.getElementById('total-items');
                const issuedItemsEl = document.getElementById('issued-items');
                const availableItemsEl = document.getElementById('available-items');
                const lowStockItemsEl = document.getElementById('low-stock-items');
                const damagedItemsEl = document.getElementById('damaged-items');

                if (totalMembersEl) totalMembersEl.textContent = members.length;
                if (totalItemsEl) totalItemsEl.textContent = items.length;
                if (issuedItemsEl) issuedItemsEl.textContent = issuedQuantity;
                if (availableItemsEl) availableItemsEl.textContent = availableQuantity;
                if (lowStockItemsEl) lowStockItemsEl.textContent = lowStockItems;
                if (damagedItemsEl) damagedItemsEl.textContent = damagedQuantity;

                console.log(`✅ Stats Updated - Members: ${members.length}, Items: ${items.length}, Available: ${availableQuantity}, Issued: ${issuedQuantity}, Low Stock: ${lowStockItems}, Damaged: ${damagedQuantity}`);
                
                // ✅ Update reports if active
                if (activeSection === 'reports') {
                    updateReportsData();
                }

            } catch (error) {
                console.error('Error updating stats:', error);
                showToast('Error updating dashboard stats', 'error');
            }
        }

        // ✅ FIXED: Issue Item Function
        async function issueItem() {
            const memberId = parseInt(document.getElementById('issue-member').value);
            const quantity = parseInt(document.getElementById('issue-quantity').value);
            const isPermanent = document.getElementById('permanent-issue')?.checked || false;

            if (!memberId || !quantity || quantity <= 0) {
                showToast('Please enter valid details', 'error');
                return;
            }

            if (quantity > selectedItem.available) {
                showToast(` Cannot issue ${quantity}. Only ${selectedItem.available} available.`, 'error');
                return;
            }

            showLoading(true);

            try {
                const { data: memberData } = await supabaseClient
                    .from('members')
                    .select('name')
                    .eq('id', memberId)
                    .single();

                const { error: issueError } = await supabaseClient
                    .from('issued_items')
                    .insert([{
                        item_id: selectedItem.id,
                        member_id: memberId,
                        quantity: quantity,
                        status: isPermanent ? 'permanent' : 'issued',
                        issued_date: new Date().toISOString()
                    }]);

                if (issueError) throw issueError;

                let newAvailable, newTotal;

                if (isPermanent) {
                    newTotal = Math.max(0, selectedItem.total - quantity);
                    newAvailable = Math.max(0, selectedItem.available - quantity);
                } else {
                    newTotal = selectedItem.total;
                    newAvailable = Math.max(0, selectedItem.available - quantity);
                }

                const { error: updateError } = await supabaseClient
                    .from('items')
                    .update({
                        available: newAvailable,
                        total: newTotal
                    })
                    .eq('id', selectedItem.id);

                if (updateError) throw updateError;

                selectedItem.available = newAvailable;
                selectedItem.total = newTotal;

                closeDialog();
                showItemDetail(selectedItem);
                updateStats();

                const issueType = isPermanent ? 'permanently assigned' : 'issued';
                const statusMsg = isPermanent
                    ? ` ${quantity} items ${issueType}. Total reduced to: ${newTotal}, Available: ${newAvailable}`
                    : ` ${quantity} items ${issueType}. Available: ${newAvailable}`;

                showToast(statusMsg, 'success');
                addAuditEntry('issue', `Item ${issueType}: ${selectedItem.name} (${quantity} units) to ${memberData?.name || 'Unknown'}`);

            } catch (error) {
                console.error('Error issuing item:', error);
                showToast('Error issuing item: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Fetch Permanent Issues
        async function fetchPermanentIssues() {
            try {
                const { data, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image),
                        members(name, branch, photo)
                    `)
                    .eq('status', 'permanent')
                    .order('issued_date', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching permanent issues:', error);
                showToast('Error loading permanent issues', 'error');
                return [];
            }
        }

        // ✅ NEW: Fetch Damaged Issues
        async function fetchDamagedIssues() {
            try {
                const { data, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image),
                        members(name, branch, photo)
                    `)
                    .eq('status', 'damaged')
                    .order('returned_date', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching damaged issues:', error);
                showToast('Error loading damaged issues', 'error');
                return [];
            }
        }

        // ✅ FIXED: Populate Permanent Issues Table
        async function populatePermanentIssuesTable() {
            const tbody = document.getElementById('permanent-issues-table');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center">Loading...</td></tr>';

            try {
                const permanentIssues = await fetchPermanentIssues();
                tbody.innerHTML = '';

                if (permanentIssues.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-500">No permanent issues found</td></tr>';
                    return;
                }

                permanentIssues.forEach(issued => {
                    const row = document.createElement('tr');
                    row.className = 'border-t bg-purple-50';
                    const issueDate = new Date(issued.issued_date).toLocaleDateString('en-US');

                    const itemImage = issued.items?.image ?
                        createImagePreview(issued.items.image, 'small') :
                        '<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 text-gray-400"></i></div>';

                    const memberPhoto = issued.members?.photo ?
                        createImagePreview(issued.members.photo, 'small', true) :
                        '<div class="profile-image bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-6 h-6 text-gray-400"></i></div>';

                    row.innerHTML = `
                        <td class="p-3">${itemImage}</td>
                        <td class="p-3">${issued.items?.name || 'Unknown'}</td>
                        <td class="p-3">${issued.members?.name || 'Unknown'}</td>
                        <td class="p-3">${memberPhoto}</td>
                        <td class="p-3">${issued.members?.branch || 'Unknown'}</td>
                        <td class="p-3">${issued.quantity}</td>
                        <td class="p-3">${issueDate}</td>
                        <td class="p-3">
                            <span class="bg-purple-500 text-white px-3 py-1 rounded-full text-xs font-bold">
                                 PERMANENT
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populatePermanentIssuesTable:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-red-500">Error loading permanent issues</td></tr>';
                showToast('Error loading permanent issues', 'error');
            }
        }

        // ✅ NEW: Populate Damaged Issues Table
        async function populateDamagedIssuesTable() {
            const tbody = document.getElementById('damaged-issues-table');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center">Loading...</td></tr>';

            try {
                const damagedIssues = await fetchDamagedIssues();
                tbody.innerHTML = '';

                if (damagedIssues.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-500">No damaged items found</td></tr>';
                    return;
                }

                damagedIssues.forEach(issued => {
                    const row = document.createElement('tr');
                    row.className = 'border-t bg-orange-50';
                    const issueDate = new Date(issued.issued_date).toLocaleDateString('en-US');
                    const damageDate = new Date(issued.returned_date).toLocaleDateString('en-US');

                    const itemImage = issued.items?.image ?
                        createImagePreview(issued.items.image, 'small') :
                        '<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 text-gray-400"></i></div>';

                    row.innerHTML = `
                        <td class="p-3">${itemImage}</td>
                        <td class="p-3">${issued.items?.name || 'Unknown'}</td>
                        <td class="p-3">${issued.members?.name || 'Unknown'}</td>
                        <td class="p-3">${issued.members?.branch || 'Unknown'}</td>
                        <td class="p-3">${issued.quantity}</td>
                        <td class="p-3">${issueDate}</td>
                        <td class="p-3">${damageDate}</td>
                        <td class="p-3">
                            ${issued.damage_reason ? 
                                `<span class="text-xs bg-orange-100 text-orange-800 px-2 py-1 rounded">${issued.damage_reason}</span>` : 
                                '<span class="text-xs text-gray-500">No reason provided</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populateDamagedIssuesTable:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-red-500">Error loading damaged issues</td></tr>';
                showToast('Error loading damaged issues', 'error');
            }
        }

        // Search damaged issues
        const searchDamagedIssues = () => {
            const term = document.getElementById('search-damaged').value.toLowerCase();
            const rows = document.querySelectorAll('#damaged-issues-table tr');
            rows.forEach(row => {
                if (row.cells.length < 3) return;
                const item = row.cells[1].textContent.toLowerCase();
                const member = row.cells[2].textContent.toLowerCase();
                row.style.display = (item.includes(term) || member.includes(term)) ? '' : 'none';
            });
        };

        // Search permanent issues
        const searchPermanentIssues = () => {
            const term = document.getElementById('search-permanent').value.toLowerCase();
            const rows = document.querySelectorAll('#permanent-issues-table tr');
            rows.forEach(row => {
                if (row.cells.length < 3) return;
                const item = row.cells[1].textContent.toLowerCase();
                const member = row.cells[2].textContent.toLowerCase();
                row.style.display = (item.includes(term) || member.includes(term)) ? '' : 'none';
            });
        };

        // ✅ UPDATED: Return Item Function
        async function returnItem(issuedItemId, quantity) {
            try {
                const confirmed = await showConfirmDialog('Are you sure you want to return this item?', true);
                if (!confirmed) return;

                showLoading(true);

                // ✅ SAHI CODE:
                await returnItemSilent(issuedItemId, quantity);

                updateStats();
                populateCurrentIssuesTable();
                populateHistoryTable();

                if (selectedItem) {
                    showItemDetail(selectedItem);
                }

                showToast(`✅ Item returned successfully!`, 'success');
                addAuditEntry('return', `Item returned: quantity ${quantity}`);

            } catch (error) {
                console.error('Error returning item:', error);
                showToast('Error returning item: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ NEW: Mark Selected Items as Damaged
        async function markSelectedDamaged() {
            const form = document.getElementById('return-selection-form');
            const selectedCheckboxes = form.querySelectorAll('input[name="return-item"]:checked');

            if (selectedCheckboxes.length === 0) {
                showToast('Please select at least one item to mark as damaged', 'error');
                return;
            }

            // ✅ Ask for damage reason
            const reason = await showDamageReasonDialog();
            if (!reason) return; // User cancelled

            const itemNames = Array.from(selectedCheckboxes).map(checkbox => {
                const label = document.querySelector(`label[for="item-${checkbox.value}"]`);
                return label ? label.textContent.split('\n')[0].trim() : 'Unknown Item';
            });

            const itemList = itemNames.map(name => `• ${name}`).join('\n');

            const confirmed = await showConfirmDialog(
                `Are you sure you want to mark these ${selectedCheckboxes.length} items as DAMAGED?\n\n${itemList}\n\nReason: ${reason}`,
                false, // Not return, it's damage
                'damaged'
            );

            if (!confirmed) return;

            showLoading(true);
            closeDialog();

            let successCount = 0;
            let failureCount = 0;

            try {
                for (const checkbox of selectedCheckboxes) {
                    try {
                        const issuedItemId = parseInt(checkbox.value);
                        const quantity = parseInt(checkbox.dataset.quantity);

                        await markItemDamaged(issuedItemId, quantity, reason);
                        successCount++;

                    } catch (error) {
                        console.error(`❌ Failed to mark item as damaged:`, error);
                        failureCount++;
                    }
                }

                if (successCount > 0 && failureCount === 0) {
                    showToast(`🔥 Successfully marked all ${successCount} items as damaged!`, 'success');
                } else if (successCount > 0 && failureCount > 0) {
                    showToast(`⚠️ Marked ${successCount} items as damaged, ${failureCount} failed`, 'error');
                } else {
                    showToast(`❌ Failed to mark all items as damaged`, 'error');
                }

                addAuditEntry('damage', `${successCount} items marked as damaged. Reason: ${reason}`);

            } catch (error) {
                console.error('💥 Critical error in markSelectedDamaged:', error);
                showToast('Error processing damage marking', 'error');
            } finally {
                showLoading(false);
                updateStats();
                populateCurrentIssuesTable();
                populateDamagedIssuesTable();
            }
        }

        // ✅ NEW: Mark Single Item as Damaged
        async function markItemDamaged(issuedItemId, quantity, reason = '') {
            try {
                // 1. Get item info
                const { data: issuedItemData, error: getError } = await supabaseClient
                    .from('issued_items')
                    .select('item_id')
                    .eq('id', issuedItemId)
                    .single();

                if (getError) throw getError;

                // 2. Update issued status to damaged
                const { error: damageError } = await supabaseClient
                    .from('issued_items')
                    .update({
                        status: 'damaged',
                        returned_date: new Date().toISOString(),
                        damage_reason: reason
                    })
                    .eq('id', issuedItemId);

                if (damageError) throw damageError;

                // 3. Update total quantity
                // 3. Update total quantity (permanently reduce from total)
                const { data: currentItem, error: itemError } = await supabaseClient
                    .from('items')
                    .select('available, total')
                    .eq('id', issuedItemData.item_id)
                    .single();

                if (itemError) throw itemError;

                const newTotal = Math.max(0, currentItem.total - quantity);
                const newAvailable = Math.max(0, currentItem.available); // Available stays same

                const { error: updateError } = await supabaseClient
                    .from('items')
                    .update({ 
                        total: newTotal,
                        available: newAvailable 
                    })
                    .eq('id', issuedItemData.item_id);

                if (updateError) throw updateError;

                // 4. Update selectedItem if same
                if (selectedItem && selectedItem.id === issuedItemData.item_id) {
                    selectedItem.total = newTotal;
                    selectedItem.available = newAvailable;
                }

                return { itemId: issuedItemData.item_id, newTotal, newAvailable };

            } catch (error) {
                console.error('Error marking item as damaged:', error);
                throw error;
            }
        }

        // ✅ NEW: Show Damage Reason Dialog
        function showDamageReasonDialog() {
            return new Promise((resolve) => {
                const backdrop = document.getElementById('confirm-backdrop');
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const deleteBtn = document.getElementById('confirm-delete');

                messageEl.innerHTML = `
                    <div class="text-left">
                        <p class="font-semibold mb-3">Please provide a reason for marking items as damaged:</p>
                        <textarea id="damage-reason-input" class="damage-reason-input" placeholder="e.g., Short circuit during testing, Physical damage, Lost during transport..."></textarea>
                    </div>
                `;

                deleteBtn.textContent = 'Mark Damaged';
                deleteBtn.className = 'confirm-btn damaged';

                backdrop.classList.remove('hidden');
                modal.classList.remove('hidden');

                function cleanup() {
                    backdrop.classList.add('hidden');
                    modal.classList.add('hidden');
                    cancelBtn.removeEventListener('click', handleCancel);
                    deleteBtn.removeEventListener('click', handleConfirm);
                }

                function handleCancel() {
                    cleanup();
                    resolve(null);
                }

                function handleConfirm() {
                    const reason = document.getElementById('damage-reason-input').value.trim();
                    if (!reason) {
                        showToast('Please provide a reason for the damage', 'error');
                        return;
                    }
                    cleanup();
                    resolve(reason);
                }

                cancelBtn.addEventListener('click', handleCancel);
                deleteBtn.addEventListener('click', handleConfirm);

                // Auto focus on textarea
                setTimeout(() => {
                    document.getElementById('damage-reason-input').focus();
                }, 100);
            });
        }

        // ✅ NEW: Show Damaged Items Page
        async function showDamagedPage() {
            showLoading(true);

            try {
                const damagedIssues = await fetchDamagedIssues();

                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById('damaged-section').classList.remove('hidden');

                const content = document.getElementById('damaged-content');

                if (damagedIssues.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4">✅</div>
                            <h3 class="text-xl font-semibold text-green-600 mb-2">Great! No Damaged Items</h3>
                            <p class="text-gray-500">No items have been marked as damaged or lost.</p>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-700">Total Damaged Items: ${damagedIssues.length}</h2>
                            <button onclick="exportDamagedItems()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Export Damaged Items
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${damagedIssues.map(issued => `
                            <div class="border-l-4 border-orange-500 bg-orange-50 rounded-r-lg p-4">
                                <div class="flex items-center gap-3 mb-3">
                                    ${issued.items?.image ?
                        `<img src="${issued.items.image}" class="w-12 h-12 object-cover rounded" alt="Item">` :
                        `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                                                <i data-lucide="package" class="w-6 h-6 text-gray-400"></i>
                                            </div>`
                    }
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${issued.items?.name || 'Unknown Item'}</h3>
                                        <p class="text-xs text-orange-600">Quantity: ${issued.quantity}</p>
                                    </div>
                                </div>
                                
                                <div class="space-y-2 text-sm">
                                    <p><strong>Member:</strong> ${issued.members?.name || 'Unknown'}</p>
                                    <p><strong>Branch:</strong> ${issued.members?.branch || 'Unknown'}</p>
                                    <p><strong>Issue Date:</strong> ${new Date(issued.issued_date).toLocaleDateString()}</p>
                                    <p><strong>Damage Date:</strong> ${new Date(issued.returned_date).toLocaleDateString()}</p>
                                    ${issued.damage_reason ? 
                        `<p><strong>Reason:</strong> <span class="text-orange-700">${issued.damage_reason}</span></p>` : 
                        '<p><strong>Reason:</strong> <span class="text-gray-500">Not provided</span></p>'
                    }
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading damaged items:', error);
                showToast('Error loading damaged items', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Highlight Search Terms
        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm || !text) return text;

            const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return text.replace(regex, '<mark class="bg-yellow-200 px-1 rounded">$1</mark>');
        }

        // ✅ Enhanced Items Search with Property Values
        async function searchItems() {
            const searchTerm = document.getElementById('search-items').value.toLowerCase().trim();

            if (!searchTerm) {
                if (selectedCategory) {
                    populateItems(selectedCategory.id);
                }
                return;
            }

            const tableRows = document.querySelectorAll('#items-table-body tr');
            let hasVisibleRows = false;

            tableRows.forEach(row => {
                if (row.cells.length < 3) return;

                let shouldShow = false;

                Array.from(row.cells).forEach(cell => {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        shouldShow = true;
                    }
                });

                if (shouldShow) {
                    row.style.display = '';
                    hasVisibleRows = true;
                } else {
                    row.style.display = 'none';
                }
            });

            if (!hasVisibleRows) {
                const tableBody = document.getElementById('items-table-body');
                tableBody.innerHTML = `
            <tr>
                <td colspan="10" class="p-4 text-center text-gray-500">
                    <div class="text-lg">🔍</div>
                    <p>No items found matching "${searchTerm}"</p>
                    <button onclick="populateItems(selectedCategory.id)" class="mt-2 bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">
                        Show All Items
                    </button>
                </td>
            </tr>
        `;
            }
        }

        // Add custom property value row
        function addCustomPropertyValue() {
            const container = document.getElementById('item-property-values-list');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-gray-50 p-2 rounded border property-value-row';
            div.innerHTML = `
                <input type="text" class="w-24 p-2 border rounded text-sm custom-property-name" placeholder="Property name">
                <span class="text-sm">:</span>
                <input type="text" class="item-property-value flex-1 p-2 border rounded" data-property-name="" placeholder="Enter value">
                <button type="button" onclick="removePropertyValueRow(this)" class="text-red-500 hover:bg-red-100 p-1 rounded" title="Remove">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(div);

            const nameInput = div.querySelector('.custom-property-name');
            const valueInput = div.querySelector('.item-property-value');
            nameInput.addEventListener('input', () => {
                valueInput.setAttribute('data-property-name', nameInput.value.trim());
            });

            lucide.createIcons();
        }

        // Add custom property value row for edit
        function addCustomPropertyValueEdit() {
            const container = document.getElementById('edit-item-property-values-list');
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 bg-gray-50 p-2 rounded border property-value-row';
            div.innerHTML = `
                <input type="text" class="w-24 p-2 border rounded text-sm custom-property-name" placeholder="Property name">
                <span class="text-sm">:</span>
                <input type="text" class="item-property-value flex-1 p-2 border rounded" data-property-name="" placeholder="Enter value">
                <button type="button" onclick="removePropertyValueRow(this)" class="text-red-500 hover:bg-red-100 p-1 rounded" title="Remove">
                    <i data-lucide="x" class="w-4 h-4"></i>
                </button>
            `;
            container.appendChild(div);

            const nameInput = div.querySelector('.custom-property-name');
            const valueInput = div.querySelector('.item-property-value');
            nameInput.addEventListener('input', () => {
                valueInput.setAttribute('data-property-name', nameInput.value.trim());
            });

            lucide.createIcons();
        }

        // Remove property value row
        function removePropertyValueRow(button) {
            button.closest('.property-value-row').remove();
        }

        // Show Low Stock Page Function
        async function showLowStockPage() {
            showLoading(true);

            try {
                const items = await fetchItems();
                const lowStockItems = items.filter(item => item.available <= 5);

                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById('low-stock-section').classList.remove('hidden');

                const content = document.getElementById('low-stock-content');

                if (lowStockItems.length === 0) {
                    content.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-xl font-semibold text-green-600 mb-2">Great! No Low Stock Items</h3>
                            <p class="text-gray-500">All items have sufficient quantity in stock.</p>
                        </div>
                    `;
                    return;
                }

                content.innerHTML = `
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xl font-bold text-gray-700">Items Requiring Attention: ${lowStockItems.length}</h2>
                            <button onclick="exportLowStockItems()" class="export-btn">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Export Low Stock Items
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${lowStockItems.map(item => `
                            <div class="border rounded-lg p-4 ${item.available === 0 ? 'border-red-500 bg-red-50' : 'border-orange-300 bg-orange-50'}">
                                <div class="flex items-center gap-3 mb-3">
                                    ${item.image ?
                        `<img src="${item.image}" class="w-12 h-12 object-cover rounded" alt="Item">` :
                        `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                                            <i data-lucide="package" class="w-6 h-6 text-gray-400"></i>
                                        </div>`
                    }
                                    <div>
                                        <h3 class="font-semibold text-gray-800">${item.name}</h3>
                                        ${item.property ? `<p class="text-xs text-blue-600">Property: ${item.property}</p>` : ''}
                                    </div>
                                </div>
                                
                                <div class="text-center p-3 rounded ${item.available === 0 ? 'bg-red-100' : 'bg-orange-100'}">
                                    <p class="text-lg font-bold ${item.available === 0 ? 'text-red-700' : 'text-orange-700'}">
                                        ${item.available === 0 ? 'OUT OF STOCK' : `Only ${item.available} left`}
                                    </p>
                                    <p class="text-sm text-gray-600">Total: ${item.total}</p>
                                </div>
                                
                                <div class="mt-3 text-center">
                                    <button onclick="showItemDetailFromLowStock(${JSON.stringify(item).replace(/"/g, '&quot;')})" 
                                            class="text-blue-500 hover:underline text-sm">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h4 class="font-semibold text-yellow-800 mb-2">Restock Recommendation:</h4>
                        <p class="text-yellow-700 text-sm">
                            Consider restocking items with low quantities to avoid stock-outs. 
                            Items marked "OUT OF STOCK" need immediate attention.
                        </p>
                    </div>
                `;

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading low stock items:', error);
                showToast('Error loading low stock items', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Show Item Detail from Low Stock Page
        function showItemDetailFromLowStock(item) {
            selectedItem = item;

            fetchCategories().then(categories => {
                selectedCategory = categories.find(cat => cat.id === item.category_id);

                setActiveSection('components');
                setTimeout(() => {
                    showItemDetail(item);
                }, 100);
            });
        }

        // Show Member Details Page - WITH SEARCH FUNCTIONALITY
        async function showMemberDetails(memberId) {
            showLoading(true);

            try {
                const { data: memberData, error: memberErr } = await supabaseClient
                    .from('members')
                    .select('*')
                    .eq('id', memberId)
                    .single();

                if (memberErr) throw memberErr;

                const { data: issuedItems, error: issuedErr } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image, property)
                    `)
                    .eq('member_id', memberId)
                    .eq('status', 'issued');

                if (issuedErr) throw issuedErr;

                selectedMember = memberData;

                document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
                document.getElementById('member-detail-section').classList.remove('hidden');

                const content = document.getElementById('member-detail-content');
                const photoHTML = memberData.photo ?
                    `<img src="${memberData.photo}" class="profile-image-large" alt="Member Photo">` :
                    `<div class="profile-image-large bg-gray-200 flex items-center justify-center">
                        <i data-lucide="user" class="w-8 h-8 text-gray-400"></i>
                    </div>`;

                content.innerHTML = `
                    <div class="member-detail-card">
                        <div class="flex items-center gap-6 mb-6">
                            ${photoHTML}
                            <div>
                                <h1 class="text-3xl font-bold mb-2">${memberData.name}</h1>
                                <div class="grid grid-cols-2 gap-4 text-sm opacity-90">
                                    <div>
                                        <p><strong>Batch:</strong> ${memberData.batch}</p>
                                        <p><strong>Branch:</strong> ${memberData.branch}</p>
                                    </div>
                                    <div>
                                        <p><strong>Year:</strong> ${memberData.year}</p>
                                        <p><strong>Contact:</strong> ${memberData.contact}</p>
                                    </div>
                                </div>
                                ${memberData.address ? `<p class="mt-2"><strong>Address:</strong> ${memberData.address}</p>` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-bold mb-4 text-gray-800">Currently Issued Items (${issuedItems.length})</h2>
                        
                        ${issuedItems.length > 0 ? `
                            <div class="mb-4">
                                <input type="text" placeholder="Search issued items..." id="search-member-items"
                                    class="w-full p-3 border rounded-lg" oninput="searchMemberItems()">
                                <p class="text-xs text-gray-500 mt-1">Search by item name or properties</p>
                            </div>
                        ` : ''}
                        
                        <div id="member-items-container">
                            ${issuedItems.length === 0 ?
                        '<p class="text-gray-500 text-center py-8">No items currently issued to this member</p>' :
                        issuedItems.map(item => `
                                <div class="member-issued-item searchable-item" data-search-text="${item.items?.name || 'Unknown Item'} ${item.items?.property || ''}">
                                    <div class="flex items-center gap-4">
                                        ${item.items?.image ?
                                `<img src="${item.items.image}" class="w-12 h-12 object-cover rounded" alt="Item">` :
                                `<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center">
                                                <i data-lucide="package" class="w-6 h-6 text-gray-400"></i>
                                            </div>`
                            }
                                        <div>
                                            <h3 class="font-semibold">${item.items?.name || 'Unknown Item'}</h3>
                                            <p class="text-sm text-gray-600">Quantity: ${item.quantity}</p>
                                            ${item.items?.property ? `<p class="text-sm text-blue-600">Property: ${item.items.property}</p>` : ''}
                                            <p class="text-xs text-gray-500">Issued: ${new Date(item.issued_date).toLocaleDateString()}</p>
                                        </div>
                                    </div>
                                    <button onclick="smartReturnFromMember(${item.id}, ${item.quantity})" 
                                            class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 text-sm">
                                        Return
                                    </button>
                                </div>
                            `).join('')
                    }
                        </div>
                        
                        <div id="no-results-message" class="hidden text-center py-8">
                            <div class="text-4xl mb-2">🔍</div>
                            <p class="text-gray-500">No items found matching your search</p>
                            <button onclick="clearMemberItemsSearch()" class="mt-2 text-blue-500 hover:underline">
                                Show All Items
                            </button>
                        </div>
                    </div>
                `;

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading member details:', error);
                showToast('Error loading member details', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Smart Return from Member Detail Page
        async function smartReturnFromMember(issuedItemId, quantity) {
            const confirmed = await showConfirmDialog('Are you sure you want to return this item?', true);
            if (!confirmed) return;

            showLoading(true);

            try {
                const { error: returnError } = await supabaseClient
                    .from('issued_items')
                    .update({
                        status: 'returned',
                        returned_date: new Date().toISOString()
                    })
                    .eq('id', issuedItemId);

                if (returnError) throw returnError;

                const { data: issuedItemData } = await supabaseClient
                    .from('issued_items')
                    .select('item_id')
                    .eq('id', issuedItemId)
                    .single();

                if (issuedItemData) {
                    const { data: itemData } = await supabaseClient
                        .from('items')
                        .select('available')
                        .eq('id', issuedItemData.item_id)
                        .single();

                    if (itemData) {
                        await supabaseClient
                            .from('items')
                            .update({
                                available: itemData.available + quantity
                            })
                            .eq('id', issuedItemData.item_id);
                    }
                }

                if (selectedMember) {
                    showMemberDetails(selectedMember.id);
                }

                updateStats();
                showToast('Item returned successfully');
                addAuditEntry('return', `Item returned from member: quantity ${quantity}`);

            } catch (error) {
                console.error('Error returning item:', error);
                showToast('Error returning item', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ NEW: Search Member Items Function
        function searchMemberItems() {
            const searchTerm = document.getElementById('search-member-items').value.toLowerCase().trim();
            const items = document.querySelectorAll('.searchable-item');
            const noResultsMsg = document.getElementById('no-results-message');
            let hasVisibleItems = false;

            items.forEach(item => {
                const searchText = item.getAttribute('data-search-text').toLowerCase();

                if (!searchTerm || searchText.includes(searchTerm)) {
                    item.style.display = 'flex';
                    hasVisibleItems = true;
                } else {
                    item.style.display = 'none';
                }
            });

            // Show/hide no results message
            if (noResultsMsg) {
                if (!hasVisibleItems && searchTerm) {
                    noResultsMsg.classList.remove('hidden');
                } else {
                    noResultsMsg.classList.add('hidden');
                }
            }
        }

        // ✅ NEW: Clear Search Function
        function clearMemberItemsSearch() {
            const searchInput = document.getElementById('search-member-items');
            if (searchInput) {
                searchInput.value = '';
                searchMemberItems(); // Trigger search to show all items
            }
        }

        // ✅ ENHANCED: Smart Return System for Admin Panel - WITH DAMAGE OPTION
        async function smartReturn(memberId, memberName) {
            try {
                const { data: issuedItems, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image)
                    `)
                    .eq('member_id', memberId)
                    .eq('status', 'issued');

                if (error) throw error;

                if (issuedItems.length === 0) {
                    showToast('No items to return for this member', 'error');
                    return;
                }

                openDialog('smartReturn');
                const title = document.getElementById('dialog-title');
                const content = document.getElementById('dialog-content');

                title.textContent = `Return Items - ${memberName}`;
                content.innerHTML = `
                    <div class="space-y-4">
                        <p class="text-gray-600 mb-4">Select items to return (multiple selection allowed):</p>
                        
                        <!-- ✅ ENHANCED: SELECT ALL & DAMAGE BUTTONS -->
                        <div class="flex gap-2 mb-4 flex-wrap">
                            <button type="button" onclick="selectAllItems(true)" class="bg-green-500 text-white px-3 py-1 rounded text-sm hover:bg-green-600">
                                ✅ Select All
                            </button>
                            <button type="button" onclick="selectAllItems(false)" class="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600">
                                ❌ Clear All
                            </button>
                            <button type="button" onclick="markSelectedDamaged()" class="bg-orange-500 text-white px-3 py-1 rounded text-sm hover:bg-orange-600">
                                🔥 Mark Damaged
                            </button>
                        </div>
                        
                        <form id="return-selection-form">
                            ${issuedItems.map(item => `
                                <div class="return-item-option">
                                    <input type="checkbox" name="return-item" value="${item.id}" data-quantity="${item.quantity}" id="item-${item.id}">
                                    <label for="item-${item.id}" class="flex items-center gap-3 flex-1 cursor-pointer">
                                        ${item.items?.image ?
                        `<img src="${item.items.image}" class="w-10 h-10 object-cover rounded" alt="Item">` :
                        `<div class="w-10 h-10 bg-gray-200 rounded flex items-center justify-center">
                                                <i data-lucide="package" class="w-5 h-5 text-gray-400"></i>
                                            </div>`
                    }
                                        <div>
                                            <p class="font-medium">${item.items?.name || 'Unknown Item'}</p>
                                            <p class="text-sm text-gray-500">Quantity: ${item.quantity}</p>
                                            <p class="text-xs text-gray-400">Issued: ${new Date(item.issued_date).toLocaleDateString()}</p>
                                        </div>
                                    </label>
                                </div>
                            `).join('')}
                        </form>
                        
                        <div class="flex gap-3 mt-6">
                            <button onclick="closeDialog()" class="flex-1 bg-gray-300 text-gray-700 py-2 rounded hover:bg-gray-400">
                                Cancel
                            </button>
                            <button onclick="processSmartReturn()" class="flex-1 bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                                Return Selected Items
                            </button>
                        </div>
                        
                        <div id="selection-counter" class="text-center text-sm text-gray-600 mt-2">
                            0 items selected
                        </div>
                    </div>
                `;

                lucide.createIcons();
                setupSelectionCounter();

            } catch (error) {
                console.error('Error in smart return:', error);
                showToast('Error loading items for return', 'error');
            }
        }

        // Process Smart Return Selection - SINGLE CONFIRMATION FOR ALL
        async function processSmartReturn() {
            const form = document.getElementById('return-selection-form');
            const selectedCheckboxes = form.querySelectorAll('input[name="return-item"]:checked');

            if (selectedCheckboxes.length === 0) {
                showToast('Please select at least one item to return', 'error');
                return;
            }

            const itemNames = Array.from(selectedCheckboxes).map(checkbox => {
                const label = document.querySelector(`label[for="item-${checkbox.value}"]`);
                return label ? label.textContent.split('\n')[0].trim() : 'Unknown Item';
            });

            const itemList = itemNames.map(name => `• ${name}`).join('\n');

            const confirmed = await showConfirmDialog(
                `Are you sure you want to return these ${selectedCheckboxes.length} items?\n\n${itemList}`,
                true
            );

            if (!confirmed) return;

            showLoading(true);
            closeDialog();

            let successCount = 0;
            let failureCount = 0;

            try {
                for (const checkbox of selectedCheckboxes) {
                    try {
                        const issuedItemId = parseInt(checkbox.value);
                        const quantity = parseInt(checkbox.dataset.quantity);

                        console.log(`🔄 Returning item ID: ${issuedItemId}, Quantity: ${quantity}`);

                        await returnItemSilent(issuedItemId, quantity);
                        successCount++;

                    } catch (error) {
                        console.error(`❌ Failed to return item:`, error);
                        failureCount++;
                    }
                }

                if (successCount > 0 && failureCount === 0) {
                    showToast(`✅ Successfully returned all ${successCount} items!`, 'success');
                } else if (successCount > 0 && failureCount > 0) {
                    showToast(`⚠️ Returned ${successCount} items, ${failureCount} failed`, 'error');
                } else {
                    showToast(`❌ Failed to return all items`, 'error');
                }

                addAuditEntry('return', `Bulk return: ${successCount} items returned successfully`);

            } catch (error) {
                console.error('💥 Critical error in processSmartReturn:', error);
                showToast('Error processing returns', 'error');
            } finally {
                showLoading(false);
                updateStats();
                populateCurrentIssuesTable();
            }
        }

        // ✅ NEW: Silent Return (No Confirmation)
        async function returnItemSilent(issuedItemId, quantity) {
            // 1. Get item info
            const { data: issuedItemData, error: getError } = await supabaseClient
                .from('issued_items')
                .select('item_id')
                .eq('id', issuedItemId)
                .single();

            if (getError) throw getError;

            // 2. Update issued status
            const { error: returnError } = await supabaseClient
                .from('issued_items')
                .update({
                    status: 'returned',
                    returned_date: new Date().toISOString()
                })
                .eq('id', issuedItemId);

            if (returnError) throw returnError;

            // 3. Update available quantity IMMEDIATELY
            const { data: currentItem, error: itemError } = await supabaseClient
                .from('items')
                .select('available, total')
                .eq('id', issuedItemData.item_id)
                .single();

            if (itemError) throw itemError;

            const newAvailable = Math.min(currentItem.total, currentItem.available + quantity);

            const { error: updateError } = await supabaseClient
                .from('items')
                .update({ available: newAvailable })
                .eq('id', issuedItemData.item_id);

            if (updateError) throw updateError;

            // 4. Update selectedItem if same
            if (selectedItem && selectedItem.id === issuedItemData.item_id) {
                selectedItem.available = newAvailable;
            }

            return { itemId: issuedItemData.item_id, newAvailable };
        }

        // ✅ SELECT ALL FUNCTIONALITY
        function selectAllItems(selectAll) {
            const checkboxes = document.querySelectorAll('input[name="return-item"]');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll;
            });
            updateSelectionCounter();
        }

        // ✅ SELECTION COUNTER
        function setupSelectionCounter() {
            const checkboxes = document.querySelectorAll('input[name="return-item"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectionCounter);
            });
            updateSelectionCounter(); // Initial count
        }

        function updateSelectionCounter() {
            const selectedCount = document.querySelectorAll('input[name="return-item"]:checked').length;
            const totalCount = document.querySelectorAll('input[name="return-item"]').length;
            const counter = document.getElementById('selection-counter');

            if (counter) {
                if (selectedCount === 0) {
                    counter.textContent = 'No items selected';
                    counter.className = 'text-center text-sm text-gray-600 mt-2';
                } else if (selectedCount === totalCount) {
                    counter.textContent = `All ${selectedCount} items selected`;
                    counter.className = 'text-center text-sm text-green-600 mt-2 font-semibold';
                } else {
                    counter.textContent = `${selectedCount} of ${totalCount} items selected`;
                    counter.className = 'text-center text-sm text-blue-600 mt-2 font-semibold';
                }
            }
        }

        //  NEW: Export Functions
        function downloadCSV(data, filename) {
            const csvContent = data.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function exportMembers() {
            try {
                showLoading(true);
                const members = await fetchMembers();
                
                const csvData = [
                    ['Name', 'Batch', 'Branch', 'Year', 'Contact', 'Address'],
                    ...members.map(member => [
                        member.name || '',
                        member.batch || '',
                        member.branch || '',
                        member.year || '',
                        member.contact || '',
                        member.address || ''
                    ])
                ];
                
                downloadCSV(csvData, `members_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Members exported successfully!', 'success');
                addAuditEntry('export', `Members data exported (${members.length} records)`);
                
            } catch (error) {
                console.error('Error exporting members:', error);
                showToast('Error exporting members', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportItems() {
            try {
                showLoading(true);
                const items = await fetchItems();
                const categories = await fetchCategories();
                
                const csvData = [
                    ['Name', 'Category', 'Total', 'Available', 'Properties'],
                    ...items.map(item => {
                        const category = categories.find(cat => cat.id === item.category_id);
                        return [
                            item.name || '',
                            category?.name || '',
                            item.total || 0,
                            item.available || 0,
                            item.property || ''
                        ];
                    })
                ];
                
                downloadCSV(csvData, `items_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Items exported successfully!', 'success');
                addAuditEntry('export', `Items data exported (${items.length} records)`);
                
            } catch (error) {
                console.error('Error exporting items:', error);
                showToast('Error exporting items', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportIssueHistory() {
            try {
                showLoading(true);
                
                const { data: issueHistory, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name),
                        members(name, branch)
                    `)
                    .order('issued_date', { ascending: false });

                if (error) throw error;
                
                const csvData = [
                    ['Item', 'Member', 'Branch', 'Quantity', 'Status', 'Issue Date', 'Return Date', 'Duration Days'],
                    ...issueHistory.map(issue => {
                        const issueDate = new Date(issue.issued_date);
                        const returnDate = issue.returned_date ? new Date(issue.returned_date) : null;
                        const duration = returnDate ? Math.ceil((returnDate - issueDate) / (1000 * 60 * 60 * 24)) : '';
                        
                        return [
                            issue.items?.name || '',
                            issue.members?.name || '',
                            issue.members?.branch || '',
                            issue.quantity || 0,
                            issue.status || '',
                            issueDate.toDateString(),
                            returnDate ? returnDate.toDateString() : '',
                            duration
                        ];
                    })
                ];
                
                downloadCSV(csvData, `issue_history_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Issue history exported successfully!', 'success');
                addAuditEntry('export', `Issue history exported (${issueHistory.length} records)`);
                
            } catch (error) {
                console.error('Error exporting issue history:', error);
                showToast('Error exporting issue history', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportDamagedItems() {
            try {
                showLoading(true);
                const damagedIssues = await fetchDamagedIssues();
                
                const csvData = [
                    ['Item', 'Member', 'Branch', 'Quantity', 'Issue Date', 'Damage Date', 'Reason'],
                    ...damagedIssues.map(issue => [
                        issue.items?.name || '',
                        issue.members?.name || '',
                        issue.members?.branch || '',
                        issue.quantity || 0,
                        new Date(issue.issued_date).toDateString(),
                        new Date(issue.returned_date).toDateString(),
                        issue.damage_reason || 'No reason provided'
                    ])
                ];
                
                downloadCSV(csvData, `damaged_items_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Damaged items exported successfully!', 'success');
                addAuditEntry('export', `Damaged items exported (${damagedIssues.length} records)`);
                
            } catch (error) {
                console.error('Error exporting damaged items:', error);
                showToast('Error exporting damaged items', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportLowStockItems() {
            try {
                showLoading(true);
                const items = await fetchItems();
                const lowStockItems = items.filter(item => item.available <= 5);
                const categories = await fetchCategories();
                
                const csvData = [
                    ['Name', 'Category', 'Available', 'Total', 'Properties', 'Status'],
                    ...lowStockItems.map(item => {
                        const category = categories.find(cat => cat.id === item.category_id);
                        return [
                            item.name || '',
                            category?.name || '',
                            item.available || 0,
                            item.total || 0,
                            item.property || '',
                            item.available === 0 ? 'OUT OF STOCK' : 'LOW STOCK'
                        ];
                    })
                ];
                
                downloadCSV(csvData, `low_stock_items_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Low stock items exported successfully!', 'success');
                addAuditEntry('export', `Low stock items exported (${lowStockItems.length} records)`);
                
            } catch (error) {
                console.error('Error exporting low stock items:', error);
                showToast('Error exporting low stock items', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportAllData() {
            try {
                showLoading(true);
                showToast('Preparing comprehensive export...', 'success');

                // Export all data types
                await exportMembers();
                await exportItems();
                await exportIssueHistory();
                
                // Also export audit log
                await exportAuditLog();
                showToast(' All data exported successfully! Check your downloads folder.', 'success');
                addAuditEntry('export', 'Complete database export performed');
                
            } catch (error) {
                console.error('Error exporting all data:', error);
                showToast('Error exporting all data', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function exportCategoryItems() {
            if (!selectedCategory) {
                showToast('No category selected', 'error');
                return;
            }

            try {
                showLoading(true);
                const items = await fetchItems(selectedCategory.id);
                
                const csvData = [
                    ['Name', 'Total', 'Available', 'Properties'],
                    ...items.map(item => [
                        item.name || '',
                        item.total || 0,
                        item.available || 0,
                        item.property || ''
                    ])
                ];
                
                downloadCSV(csvData, `${selectedCategory.name}_items_${new Date().toISOString().split('T')[0]}.csv`);
                showToast(`${selectedCategory.name} items exported successfully!`, 'success');
                addAuditEntry('export', `Category items exported: ${selectedCategory.name} (${items.length} records)`);
                
            } catch (error) {
                console.error('Error exporting category items:', error);
                showToast('Error exporting category items', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ NEW: Audit Log Functions
        function populateAuditLog() {
            const container = document.getElementById('audit-log-container');
            if (!container) return;

            if (auditLog.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No audit entries found</p>';
                return;
            }

            container.innerHTML = auditLog.map(entry => `
                <div class="audit-entry ${entry.action}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <i data-lucide="${getAuditIcon(entry.action)}" class="w-4 h-4"></i>
                            <span class="font-semibold capitalize">${entry.action}</span>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(entry.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="text-sm text-gray-700">${entry.details}</p>
                    <p class="text-xs text-gray-500 mt-1">User: ${entry.user}</p>
                </div>
            `).join('');

            lucide.createIcons();
        }

        function getAuditIcon(action) {
            const icons = {
                'create': 'plus-circle',
                'update': 'edit',
                'delete': 'trash-2',
                'issue': 'arrow-right',
                'return': 'arrow-left',
                'damage': 'alert-triangle',
                'export': 'download',
                'system': 'settings'
            };
            return icons[action] || 'activity';
        }

        function searchAuditLog() {
            const term = document.getElementById('search-audit').value.toLowerCase();
            const entries = document.querySelectorAll('.audit-entry');
            
            entries.forEach(entry => {
                const text = entry.textContent.toLowerCase();
                entry.style.display = text.includes(term) ? 'block' : 'none';
            });
        }

        function clearAuditLog() {
            if (confirm('Are you sure you want to clear the audit log? This action cannot be undone.')) {
                auditLog = [];
                localStorage.removeItem('inventoryAuditLog');
                populateAuditLog();
                showToast('Audit log cleared', 'success');
                addAuditEntry('system', 'Audit log cleared by user');
            }
        }

        function exportAuditLog() {
            try {
                const csvData = [
                    ['Timestamp', 'Action', 'Details', 'User'],
                    ...auditLog.map(entry => [
                        new Date(entry.timestamp).toLocaleString(),
                        entry.action,
                        entry.details,
                        entry.user
                    ])
                ];
                
                downloadCSV(csvData, `audit_log_${new Date().toISOString().split('T')[0]}.csv`);
                showToast('Audit log exported successfully!', 'success');
                addAuditEntry('export', `Audit log exported (${auditLog.length} entries)`);
                
            } catch (error) {
                console.error('Error exporting audit log:', error);
                showToast('Error exporting audit log', 'error');
            }
        }

        // ✅ NEW: Reports Functions
        async function updateReportsData() {
            try {
                // Quick Analytics
                const members = await fetchMembers();
                const items = await fetchItems();
                
                const { data: allIssues } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name),
                        members(name)
                    `);

                // Calculate analytics
               // const totalValue = items.reduce((sum, item) => sum + (item.total * 10), 0); // Assuming avg value of 10 per item
                
                // Most active member
                const memberCounts = {};
                allIssues?.forEach(issue => {
                    const memberName = issue.members?.name || 'Unknown';
                    memberCounts[memberName] = (memberCounts[memberName] || 0) + 1;
                });
                const mostActiveMember = Object.keys(memberCounts).reduce((a, b) => 
                    memberCounts[a] > memberCounts[b] ? a : b, 'None');

                // Most issued item
                const itemCounts = {};
                allIssues?.forEach(issue => {
                    const itemName = issue.items?.name || 'Unknown';
                    itemCounts[itemName] = (itemCounts[itemName] || 0) + issue.quantity;
                });
                const mostIssuedItem = Object.keys(itemCounts).reduce((a, b) => 
                    itemCounts[a] > itemCounts[b] ? a : b, 'None');

                // Average duration
                const returnedIssues = allIssues?.filter(issue => issue.status === 'returned' && issue.returned_date) || [];
                const avgDuration = returnedIssues.length > 0 ? 
                    Math.round(returnedIssues.reduce((sum, issue) => {
                        const days = (new Date(issue.returned_date) - new Date(issue.issued_date)) / (1000 * 60 * 60 * 24);
                        return sum + days;
                    }, 0) / returnedIssues.length) : 0;

                // Update UI
                //document.getElementById('total-value').textContent = `$${totalValue.toLocaleString()}`;
                document.getElementById('most-active-member').textContent = mostActiveMember;
                document.getElementById('most-issued-item').textContent = mostIssuedItem;
                document.getElementById('avg-duration').textContent = `${avgDuration} days`;

                // Category breakdown
                const categories = await fetchCategories();
                const categoryBreakdown = document.getElementById('category-breakdown');
                categoryBreakdown.innerHTML = categories.map(cat => {
                    const categoryItems = items.filter(item => item.category_id === cat.id);
                    return `
                        <div class="flex justify-between text-sm mb-1">
                            <span>${cat.name}</span>
                            <span class="font-semibold">${categoryItems.length}</span>
                        </div>
                    `;
                }).join('');

                // Low stock report
                const lowStockReport = document.getElementById('low-stock-report');
                const lowStockItems = items.filter(item => item.available <= 5);
                lowStockReport.innerHTML = lowStockItems.slice(0, 5).map(item => `
                    <div class="flex justify-between text-sm text-red-600">
                        <span>${item.name}</span>
                        <span>${item.available} left</span>
                    </div>
                `).join('') || '<p class="text-green-600 text-sm">All items well stocked!</p>';

                // Recent activity
                const recentActivity = document.getElementById('recent-activity');
                recentActivity.innerHTML = auditLog.slice(0, 5).map(entry => `
                    <div class="text-sm text-gray-600">
                        <span class="font-medium">${entry.action}:</span> ${entry.details.substring(0, 50)}...
                        <div class="text-xs text-gray-400">${new Date(entry.timestamp).toLocaleString()}</div>
                    </div>
                `).join('') || '<p class="text-gray-500 text-sm">No recent activity</p>';

            } catch (error) {
                console.error('Error updating reports data:', error);
            }
        }

        // Add Property Input Field
        function addPropertyInput(containerId = 'properties-list') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2';
            div.innerHTML = `
                <input type="text" class="property-input flex-1 p-2 border rounded" placeholder="Property name">
                <button type="button" onclick="removePropertyInput(this)" class="property-remove-btn">×</button>
            `;
            container.appendChild(div);
        }

        // Remove Property Input Field
        function removePropertyInput(button) {
            button.parentElement.remove();
        }

        // Update Category with Properties
        async function updateCategory(categoryId) {
            const name = document.getElementById('edit-category-name').value.trim();
            const description = document.getElementById('edit-category-description').value.trim();
            const imageEl = document.getElementById('edit-category-image-preview');
            const image = (imageEl && imageEl.src && imageEl.src !== 'data:,') ? imageEl.src : '📦';

            const propertyInputs = document.querySelectorAll('#edit-properties-list .property-input');
            const properties = Array.from(propertyInputs)
                .map(input => input.value.trim())
                .filter(value => value.length > 0);

            if (!name) {
                showToast('Please enter category name', 'error');
                return;
            }

            showLoading(true);

            try {
                const { error } = await supabaseClient
                    .from('categories')
                    .update({
                        name,
                        description,
                        image,
                        properties
                    })
                    .eq('id', categoryId);

                if (error) throw error;

                closeDialog();
                populateCategories();
                showToast('Category updated successfully');
                addAuditEntry('update', `Category updated: ${name}`);

            } catch (error) {
                console.error('Error updating category:', error);
                showToast('Error updating category', 'error');
            } finally {
                showLoading(false);
            }
        }

        // Edit Item with Property Values
        async function editItem(itemId) {
            try {
                const { data, error } = await supabaseClient
                    .from('items')
                    .select('*')
                    .eq('id', itemId)
                    .single();

                if (error) throw error;

                openDialog('editItem');
                document.getElementById('dialog-title').textContent = 'Edit Item';
                const content = document.getElementById('dialog-content');

                let propertyValuesHTML = '';
                const currentValues = data.property_values || [];

                if (selectedCategory && selectedCategory.properties) {
                    selectedCategory.properties.forEach(prop => {
                        const existingValue = currentValues.find(pv => pv.propertyName === prop);
                        const value = existingValue ? existingValue.value : '';

                        propertyValuesHTML += `
                            <div class="flex items-center gap-2 bg-blue-50 p-2 rounded border property-value-row">
                                <label class="w-24 text-sm font-medium">${prop}:</label>
                                <input type="text" 
                                       class="item-property-value flex-1 p-2 border rounded" 
                                       data-property-name="${prop}" 
                                       value="${value}"
                                       placeholder="Enter ${prop} value">
                                <button type="button" onclick="removePropertyValueRow(this)" class="text-red-500 hover:bg-red-100 p-1 rounded">
                                    <i data-lucide="x" class="w-4 h-4"></i>
                                </button>
                            </div>
                        `;
                    });
                }

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <label for="edit-item-image-input" class="image-upload-area w-24 h-24 mx-auto rounded-lg overflow-hidden border-2 flex items-center justify-center bg-gray-50 cursor-pointer">
                                <img id="edit-item-image-preview" src="${data.image || 'data:,'}" class="w-full h-full object-cover ${data.image ? '' : 'hidden'}">
                                <div id="edit-item-image-placeholder" class="text-center ${data.image ? 'hidden' : ''}">
                                    <i data-lucide="image" class="w-8 h-8 mx-auto text-gray-400 mb-1"></i>
                                    <p class="text-xs text-gray-500">Change Image</p>
                                </div>
                            </label>
                            <input type="file" id="edit-item-image-input" accept="image/*" class="hidden" onchange="handleItemImage(this, 'edit')">
                        </div>
                        <input type="text" value="${data.name}" placeholder="Item Name" id="edit-item-name" class="w-full p-2 border rounded" required />
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Property Values:</label>
                            <div id="edit-item-property-values-list" class="space-y-2">
                                ${propertyValuesHTML}
                            </div>
                            <button type="button" onclick="addCustomPropertyValueEdit()" class="mt-2 text-blue-500 hover:underline text-sm">+ Add Custom Property</button>
                        </div>
                        
                        <input type="number" value="${data.total}" placeholder="Total Quantity" id="edit-item-total" class="w-full p-2 border rounded" min="1" required />
                        <p class="text-sm text-gray-500">Available Quantity: <strong>${data.available}</strong></p>
                        <button onclick="updateItem(${itemId})" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                            Update Item
                        </button>
                    </div>
                `;

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading item for edit:', error);
                showToast('Error loading item for edit', 'error');
            }
        }

        // Update Item with Property Values
        async function updateItem(itemId) {
            const name = document.getElementById('edit-item-name').value.trim();
            const newTotal = parseInt(document.getElementById('edit-item-total').value);
            const imageEl = document.getElementById('edit-item-image-preview');
            const image = (imageEl && imageEl.src && imageEl.src !== 'data:,') ? imageEl.src : null;

            const propertyValueInputs = document.querySelectorAll('#edit-item-property-values-list .item-property-value');
            const propertyValues = [];

            propertyValueInputs.forEach(input => {
                const propertyName = input.getAttribute('data-property-name');
                const value = input.value.trim();
                if (propertyName && value) {
                    propertyValues.push({
                        propertyName: propertyName,
                        value: value
                    });
                }
            });

            const propertyString = propertyValues.map(pv => `${pv.propertyName}: ${pv.value}`).join(', ');

            if (!name || !newTotal || newTotal <= 0) {
                showToast('Please enter valid item details', 'error');
                return;
            }

            showLoading(true);

            try {
                const { data: currentItem } = await supabaseClient
                    .from('items')
                    .select('total, available')
                    .eq('id', itemId)
                    .single();

                if (!currentItem) {
                    throw new Error('Item not found');
                }

                const issuedQuantity = currentItem.total - currentItem.available;

                if (newTotal < issuedQuantity) {
                    showDetailedError(
                        `Cannot set total quantity to ${newTotal}`,
                        `${issuedQuantity} items are currently issued. Total must be at least ${issuedQuantity}.`
                    );
                    return;
                }

                const newAvailable = newTotal - issuedQuantity;

                const { error } = await supabaseClient
                    .from('items')
                    .update({
                        name,
                        property: propertyString,
                        property_values: propertyValues,
                        total: newTotal,
                        available: newAvailable,
                        image
                    })
                    .eq('id', itemId);

                if (error) throw error;

                closeDialog();
                showToast(` Item updated! Available: ${newAvailable}, Total: ${newTotal}`);
                addAuditEntry('update', `Item updated: ${name}`);

            } catch (error) {
                console.error('Error updating item:', error);
                showToast('Error updating item: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Admin tab switching function
        function setActiveAdminTab(tab) {
            activeAdminTab = tab;

            document.querySelectorAll('.admin-tab').forEach(btn => {
                if (btn.dataset.adminTab === tab) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            document.querySelectorAll('.admin-tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            if (tab === 'current') {
                document.getElementById('current-issues-content').classList.remove('hidden');
                populateCurrentIssuesTable();
            } else if (tab === 'history') {
                document.getElementById('history-content').classList.remove('hidden');
                populateHistoryTable();
            } else if (tab === 'permanent') {
                document.getElementById('permanent-issues-content').classList.remove('hidden');
                populatePermanentIssuesTable();
            } else if (tab === 'damaged') {
                document.getElementById('damaged-issues-content').classList.remove('hidden');
                populateDamagedIssuesTable();
            }
        }

        // Image upload function
        async function uploadImageToStorage(file, bucketName = 'category-images') {
            try {
                const timestamp = Date.now();
                const fileExt = file.name.split('.').pop().toLowerCase();
                const cleanFileName = file.name.replace(/[^a-zA-Z0-9.-]/g, '_');
                const fileName = `${timestamp}_${cleanFileName}`;

                console.log(` Uploading to bucket: ${bucketName}, file: ${fileName}`);
                showToast('Uploading image to storage...');

                const { data, error } = await supabaseClient.storage
                    .from(bucketName)
                    .upload(fileName, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (error) {
                    console.error(' Storage upload error:', error);
                    showToast('Storage upload failed: ' + error.message, 'error');

                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            console.log(' Fallback to base64 due to storage error');
                            showToast('Using fallback method for image storage', 'error');
                            resolve(e.target.result);
                        };
                        reader.readAsDataURL(file);
                    });
                }

                const { data: { publicUrl } } = supabaseClient.storage
                    .from(bucketName)
                    .getPublicUrl(fileName);

                console.log(' Image uploaded successfully:', publicUrl);
                showToast('Image uploaded successfully');
                return publicUrl;

            } catch (error) {
                console.error(' Error uploading to storage:', error);
                showToast('Upload error: ' + error.message, 'error');

                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        resolve(e.target.result);
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        function handleImageUpload(file, callback, bucketName = 'category-images') {
            if (file && file.type.startsWith('image/')) {
                if (file.size > 5 * 1024 * 1024) {
                    showToast('Image size should be less than 5MB', 'error');
                    return;
                }

                console.log(`📸 Processing image: ${file.name}, size: ${(file.size / 1024 / 1024).toFixed(2)}MB`);
                uploadImageToStorage(file, bucketName).then(callback);
            } else {
                showToast('Please select a valid image file', 'error');
            }
        }

        function handleCategoryImage(input, mode = 'add') {
            const file = input.files[0];
            if (file) {
                console.log(' Category image selected:', file.name);

                handleImageUpload(file, (imageSrc) => {
                    const previewId = mode === 'edit' ? 'edit-category-image-preview' : 'category-image-preview';
                    const placeholderId = mode === 'edit' ? 'edit-category-image-placeholder' : 'category-image-placeholder';

                    const preview = document.getElementById(previewId);
                    const placeholder = document.getElementById(placeholderId);
                    if (preview && placeholder) {
                        preview.src = imageSrc;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        console.log(' Category image preview updated');
                    }
                }, 'category-images');
            }
        }

        function handleMemberPhoto(input, mode = 'add') {
            const file = input.files[0];
            if (file) {
                console.log('👤 Member photo selected:', file.name);

                handleImageUpload(file, (imageSrc) => {
                    const previewId = mode === 'edit' ? 'edit-member-photo-preview' : 'member-photo-preview';
                    const placeholderId = mode === 'edit' ? 'edit-member-photo-placeholder' : 'member-photo-placeholder';

                    const preview = document.getElementById(previewId);
                    const placeholder = document.getElementById(placeholderId);
                    if (preview && placeholder) {
                        preview.src = imageSrc;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        console.log(' Member photo preview updated');
                    }
                }, 'member-photos');
            }
        }

        function handleItemImage(input, mode = 'add') {
            const file = input.files[0];
            if (file) {
                console.log('🔧 Item image selected:', file.name);

                handleImageUpload(file, (imageSrc) => {
                    const previewId = mode === 'edit' ? 'edit-item-image-preview' : 'item-image-preview';
                    const placeholderId = mode === 'edit' ? 'edit-item-image-placeholder' : 'item-image-placeholder';

                    const preview = document.getElementById(previewId);
                    const placeholder = document.getElementById(placeholderId);
                    if (preview && placeholder) {
                        preview.src = imageSrc;
                        preview.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        console.log(' Item image preview updated');
                    }
                }, 'component-images');
            }
        }

        function createImagePreview(imageSrc, size = 'small', circular = false) {
            const sizeClasses = {
                small: 'w-12 h-12',
                medium: 'w-20 h-20',
                large: 'w-32 h-32'
            };

            const shapeClass = circular ? 'profile-image' : 'rounded border';

            if (imageSrc && (imageSrc.startsWith('data:image') || imageSrc.startsWith('http'))) {
                return `<img src="${imageSrc}" class="${sizeClasses[size]} object-cover ${shapeClass}" alt="Preview" onerror="this.style.display='none'">`;
            }
            return `<div class="${sizeClasses[size]} bg-gray-200 ${shapeClass} flex items-center justify-center text-gray-400">
                <i data-lucide="image" class="w-6 h-6"></i>
            </div>`;
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            if (!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'show', 'success', 'error');

            if (type === 'success') {
                toast.classList.add('success');
            } else {
                toast.classList.add('error');
            }

            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 300);
            }, 3000);
        }

        // Show Confirm Dialog
        function showConfirmDialog(message, isReturn = false, actionType = 'delete') {
            return new Promise((resolve) => {
                const backdrop = document.getElementById('confirm-backdrop');
                const modal = document.getElementById('confirm-modal');
                const messageEl = document.getElementById('confirm-message');
                const cancelBtn = document.getElementById('confirm-cancel');
                const deleteBtn = document.getElementById('confirm-delete');

                messageEl.textContent = message;

                if (isReturn) {
                    deleteBtn.textContent = 'Return';
                    deleteBtn.className = 'confirm-btn return';
                } else if (actionType === 'damaged') {
                    deleteBtn.textContent = 'Mark Damaged';
                    deleteBtn.className = 'confirm-btn damaged';
                } else {
                    deleteBtn.textContent = 'Delete';
                    deleteBtn.className = 'confirm-btn delete';
                }

                backdrop.classList.remove('hidden');
                modal.classList.remove('hidden');

                function cleanup() {
                    backdrop.classList.add('hidden');
                    modal.classList.add('hidden');
                    cancelBtn.removeEventListener('click', handleCancel);
                    deleteBtn.removeEventListener('click', handleDelete);
                }

                function handleCancel() {
                    cleanup();
                    resolve(false);
                }

                function handleDelete() {
                    cleanup();
                    resolve(true);
                }

                cancelBtn.addEventListener('click', handleCancel);
                deleteBtn.addEventListener('click', handleDelete);
            });
        }

        // Authentication functions
        async function signIn() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            showLoading(true);

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        showToast('Invalid email or password! Please check and try again.', 'error');
                    } else if (error.message.includes('Email not confirmed')) {
                        showToast('Email not verified! Please check your verification email.', 'error');
                    } else {
                        showToast('Login error: ' + error.message, 'error');
                    }
                    return;
                }

                currentUser = data.user;
                showMainApp();
                showToast('Successfully logged in');
                addAuditEntry('system', `User logged in: ${data.user.email}`);

            } catch (error) {
                console.error('Sign in error:', error);
                showToast('Technical error during login', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function signUp() {
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value.trim();
            const confirmPassword = document.getElementById('signup-confirm').value.trim();

            if (!email || !password || !confirmPassword) {
                showToast('Please fill all fields', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('Password should be at least 6 characters', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showToast('Passwords do not match', 'error');
                return;
            }

            showLoading(true);

            try {
                const { data, error } = await supabaseClient.auth.signUp({
                    email,
                    password
                });

                if (error) throw error;

                showToast('Account created! Please sign in now.');
                showSignIn();
                addAuditEntry('system', `New user registered: ${email}`);

            } catch (error) {
                console.error('Sign up error:', error);
                showToast('Sign up error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function signOut() {
            const { error } = await supabaseClient.auth.signOut();
            if (error) {
                showToast('Error signing out', 'error');
            } else {
                addAuditEntry('system', `User logged out: ${currentUser?.email || 'Unknown'}`);
                currentUser = null;
                isInitialized = false;
                cleanupSubscriptions();
                showAuthModal();
                showToast('Successfully logged out');
            }
        }

        async function resendVerificationEmail() {
            const email = document.getElementById('login-email').value.trim();

            if (!email) {
                showToast('Please enter email', 'error');
                return;
            }

            try {
                const { error } = await supabaseClient.auth.resend({
                    type: 'signup',
                    email: email
                });

                if (error) throw error;

                showToast('Verification email resent! Please check your email.');
            } catch (error) {
                showToast('Error sending email: ' + error.message, 'error');
            }
        }

        function showSignIn() {
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('signup-form').classList.add('hidden');
        }

        function showSignUp() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        }

        function showAuthModal() {
            document.getElementById('auth-modal').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('auth-modal').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
        }

        function showLoading(show) {
            if (show) {
                document.getElementById('loading-overlay').classList.remove('hidden');
            } else {
                document.getElementById('loading-overlay').classList.add('hidden');
            }
        }

        // Database Functions
        async function fetchMembers() {
            try {
                const { data, error } = await supabaseClient
                    .from('members')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching members:', error);
                showToast('Error loading members', 'error');
                return [];
            }
        }

        async function fetchCategories() {
            try {
                const { data, error } = await supabaseClient
                    .from('categories')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching categories:', error);
                showToast('Error loading categories', 'error');
                return [];
            }
        }

        async function fetchItems(categoryId = null) {
            try {
                let query = supabaseClient
                    .from('items')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (categoryId) {
                    query = query.eq('category_id', categoryId);
                }

                const { data, error } = await query;

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching items:', error);
                showToast('Error loading items', 'error');
                return [];
            }
        }

        //  FIXED: Fetch current issued items (including permanent)
        // SAHI CODE:
        async function fetchCurrentIssues() {
            try {
                const { data, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image),
                        members(name, branch, photo)
                    `)
                    .eq('status', 'issued')  // ✅ केवल 'issued' items
                    .order('issued_date', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching current issues:', error);
                showToast('Error loading current issues', 'error');
                return [];
            }
        }

        // Fetch history (returned items)
        async function fetchHistory() {
            try {
                const { data, error } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        items(name, image),
                        members(name, branch, photo)
                    `)
                    .eq('status', 'returned')
                    .order('returned_date', { ascending: false });

                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }

                return data || [];
            } catch (error) {
                console.error('Error fetching history:', error);
                showToast('Error loading history', 'error');
                return [];
            }
        }

        // ✅ FIXED: CRUD Functions - DUPLICATE PREVENTION
        async function addMember() {
            const name = document.getElementById('member-name').value.trim();
            const batch = document.getElementById('member-batch').value.trim();
            const branch = document.getElementById('member-branch').value.trim();
            const year = document.getElementById('member-year').value.trim();
            const contact = document.getElementById('member-contact').value.trim();
            const address = document.getElementById('member-address').value.trim();
            const photoEl = document.getElementById('member-photo-preview');
            const photo = photoEl && photoEl.src !== 'data:,' ? photoEl.src : null;

            if (!name || !batch || !branch || !year || !contact) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            showLoading(true);

            try {
                // ✅ CHECK FOR DUPLICATE MEMBER NAME
                const { data: existingMember, error: checkError } = await supabaseClient
                    .from('members')
                    .select('id, name')
                    .eq('name', name)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // PGRST116 = no rows found
                    throw checkError;
                }

                if (existingMember) {
                    showToast(` Member "${name}" already exists! Please use a different name.`, 'error');
                    return;
                }

                const { data, error } = await supabaseClient
                    .from('members')
                    .insert([{
                        name,
                        batch,
                        branch,
                        year,
                        contact,
                        address,
                        photo
                    }]);

                if (error) throw error;

                closeDialog();
                populateMembersTable();
                updateStats();
                showToast(` Member "${name}" added successfully`);
                addAuditEntry('create', `Member added: ${name}`);

            } catch (error) {
                console.error('Error adding member:', error);
                showToast('Error adding member: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Add Category with Properties - DUPLICATE PREVENTION
        async function addCategory() {
            const name = document.getElementById('category-name').value.trim();
            const description = document.getElementById('category-description').value.trim();
            const imageEl = document.getElementById('category-image-preview');
            const image = imageEl && imageEl.src !== 'data:,' ? imageEl.src : 'images/logo.png ';
            const type = activeTab;

            const propertyInputs = document.querySelectorAll('#properties-list .property-input');
            const properties = Array.from(propertyInputs)
                .map(input => input.value.trim())
                .filter(value => value.length > 0);

            if (!name) {
                showToast('Please enter category name', 'error');
                return;
            }

            showLoading(true);

            try {
                // ✅ CHECK FOR DUPLICATE CATEGORY NAME
                const { data: existingCategory, error: checkError } = await supabaseClient
                    .from('categories')
                    .select('id, name')
                    .eq('name', name)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // No rows found is OK
                    throw checkError;
                }

                if (existingCategory) {
                    showToast(` Category "${name}" already exists! Please use a different name.`, 'error');
                    return;
                }

                console.log(' Saving category with properties:', properties);

                const { data, error } = await supabaseClient
                    .from('categories')
                    .insert([{
                        name,
                        description,
                        image,
                        type,
                        properties
                    }]);

                if (error) throw error;

                closeDialog();
                populateCategories();
                showToast(` Category "${name}" added successfully`);
                addAuditEntry('create', `Category added: ${name} with ${properties.length} properties`);

            } catch (error) {
                console.error('Error adding category:', error);
                showToast('Error adding category: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ✅ FIXED: Add Item with Property Values - DUPLICATE PREVENTION
        async function addItem() {
            const getDialogInputValue = (id) => {
                const element = document.querySelector(`#dialog-content input#${id}`);
                if (!element) {
                    console.error(` Dialog input not found: ${id}`);
                    return null;
                }
                return element.value ? element.value.trim() : '';
            };

            const name = getDialogInputValue('item-name');
            const totalStr = getDialogInputValue('item-total');

            if (!name || name.length === 0) {
                showToast('Please enter item name', 'error');
                return;
            }

            const total = parseInt(totalStr, 10);
            if (isNaN(total) || total <= 0) {
                showToast('Please enter valid quantity', 'error');
                return;
            }

            if (!selectedCategory || !selectedCategory.id) {
                showToast('Please select a category first', 'error');
                return;
            }

            showLoading(true);

            try {
                //  CHECK FOR DUPLICATE ITEM NAME IN SAME CATEGORY
                const { data: existingItem, error: checkError } = await supabaseClient
                    .from('items')
                    .select('id, name')
                    .eq('name', name)
                    .eq('category_id', selectedCategory.id)
                    .single();

                if (checkError && checkError.code !== 'PGRST116') { // No rows found is OK
                    throw checkError;
                }

                if (existingItem) {
                    showToast(` Item "${name}" already exists in this category! Please use a different name.`, 'error');
                    return;
                }

                const propertyValueInputs = document.querySelectorAll('#item-property-values-list .item-property-value');
                const propertyValues = [];

                propertyValueInputs.forEach(input => {
                    const propertyName = input.getAttribute('data-property-name');
                    const value = input.value.trim();
                    if (propertyName && value) {
                        propertyValues.push({
                            propertyName: propertyName,
                            value: value
                        });
                    }
                });

                const propertyString = propertyValues.map(pv => `${pv.propertyName}: ${pv.value}`).join(', ');

                const imageEl = document.querySelector('#dialog-content img#item-image-preview');
                const image = (imageEl && imageEl.src && imageEl.src !== 'data:,') ? imageEl.src : null;

                const { data, error } = await supabaseClient
                    .from('items')
                    .insert([{
                        name: name,
                        property: propertyString,
                        property_values: propertyValues,
                        total: total,
                        available: total,
                        category_id: selectedCategory.id,
                        image: image
                    }])
                    .select();

                if (error) {
                    console.error(' Supabase insert error:', error);
                    showToast('Database error: ' + error.message, 'error');
                    return;
                }

                closeDialog();
                await populateItems(selectedCategory.id);
                await updateStats();
                showToast(` Item "${name}" added successfully`, 'success');
                addAuditEntry('create', `Item added: ${name} (${total} units) in ${selectedCategory.name}`);

            } catch (error) {
                console.error(' Unexpected error:', error);
                showToast('Unexpected error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

       // setActiveSection function में यह code add करें:

function setActiveSection(section) {
    console.log('Navigating to:', section);
    activeSection = section;

    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));

    const targetSection = document.getElementById(section + '-section');
    if (targetSection) {
        targetSection.classList.remove('hidden');
    } else {
        console.error('Section not found:', section);
        return;
    }

    // Navigation styling code...

    try {
        if (section === 'members') {
            populateMembersTable();
        } else if (section === 'components') {
            showCategoriesView();
            populateCategories();
        } else if (section === 'admin') {
            setActiveAdminTab(activeAdminTab);
        } else if (section === 'dashboard') {
            updateStats();
        } else if (section === 'low-stock') {
            showLowStockPage();
        } else if (section === 'reports') {
            // ✅ REAL-TIME REPORTS UPDATE
            updateReportsData();
            console.log(' Reports section activated - real-time updates enabled');
        } else if (section === 'audit') {
            populateAuditLog();
        }
    } catch (error) {
        console.error('Error loading section data:', error);
        showToast('Error loading data', 'error');
    }
}


        function setActiveTab(tab) {
            activeTab = tab;

            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.className = 'tab-btn pb-2 px-1 border-b-2 border-blue-500 text-blue-600 font-semibold';
                } else {
                    btn.className = 'tab-btn pb-2 px-1 text-gray-500';
                }
            });

            populateCategories();
        }

        async function populateMembersTable() {
            const tbody = document.getElementById('members-table-body');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-center">Loading...</td></tr>';

            try {
                const members = await fetchMembers();
                tbody.innerHTML = '';

                if (members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-gray-500">No members found</td></tr>';
                    return;
                }

                members.forEach(member => {
                    const row = document.createElement('tr');
                    row.className = 'border-t hover:bg-gray-50 cursor-pointer';

                    const photoHTML = member.photo ?
                        createImagePreview(member.photo, 'small', true) :
                        '<div class="profile-image bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-6 h-6 text-gray-400"></i></div>';

                    row.innerHTML = `
                        <td class="p-3">${photoHTML}</td>
                        <td class="p-3 text-blue-600 font-medium hover:underline" onclick="showMemberDetails(${member.id})">${member.name}</td>
                        <td class="p-3">${member.batch}</td>
                        <td class="p-3">${member.branch}</td>
                        <td class="p-3">${member.year}</td>
                        <td class="p-3">${member.contact}</td>
                        <td class="p-3">
                            <div class="flex gap-2">
                                <button onclick="event.stopPropagation(); deleteMember(${member.id})" class="text-red-500 hover:bg-red-50 p-1 rounded">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populateMembersTable:', error);
                tbody.innerHTML = '<tr><td colspan="7" class="p-3 text-center text-red-500">Error loading members</td></tr>';
                showToast('Error loading members', 'error');
            }
        }

        async function populateCategories() {
            const grid = document.getElementById('categories-grid');
            if (!grid) return;

            grid.innerHTML = '<div class="col-span-full text-center p-8">Loading categories...</div>';

            try {
                const categories = await fetchCategories();
                const filteredCategories = categories.filter(cat => cat.type === activeTab);

                grid.innerHTML = '';

                if (filteredCategories.length === 0) {
                    grid.innerHTML = '<div class="col-span-full text-center p-8 text-gray-500">No categories found</div>';
                    return;
                }

                for (const category of filteredCategories) {
                    const items = await fetchItems(category.id);
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'border rounded-lg p-6 text-center hover:shadow-md cursor-pointer transition-shadow hover-lift relative group';

                    const displayImage = category.image && (category.image.startsWith('data:') || category.image.startsWith('http')) ?
                        `<img src="${category.image}" class="category-image mx-auto mb-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="text-4xl mb-3" style="display:none;">📦</div>` :
                        `<div class="text-4xl mb-3">${category.image || ''}</div>`;

                    const descriptionHTML = category.description ?
                        `<p class="text-xs text-gray-400 mb-2 line-clamp-2">${category.description}</p>` : '';

                    const propertiesHTML = category.properties && category.properties.length > 0 ?
                        `<p class="text-xs text-blue-500 mb-2">Properties: ${category.properties.join(', ')}</p>` : '';

                    categoryDiv.innerHTML = `
                        <div onclick="showItemsView(${JSON.stringify(category).replace(/"/g, '&quot;')})">
                            ${displayImage}
                            <h3 class="font-semibold mb-2">${category.name}</h3>
                            ${descriptionHTML}
                            ${propertiesHTML}
                            <p class="text-sm text-gray-500">${items.length} items</p>
                        </div>
                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <div class="relative">
                                <button onclick="event.stopPropagation(); toggleMenu('category-menu-${category.id}', event)" class="p-1 hover:bg-gray-200 rounded">
                                    <i data-lucide="more-vertical" class="w-4 h-4"></i>
                                </button>
                                <div id="category-menu-${category.id}" class="dropdown-menu">
                                    <button onclick="editCategory(${category.id})" class="dropdown-item">
                                        <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>Edit
                                    </button>
                                    <button onclick="deleteCategory(${category.id})" class="dropdown-item delete">
                                        <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    grid.appendChild(categoryDiv);
                }

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populateCategories:', error);
                grid.innerHTML = '<div class="col-span-full text-center p-8 text-red-500">Error loading categories</div>';
                showToast('Error loading categories', 'error');
            }
        }

        //  ENHANCED TABLE WITH SIMPLE NUMBERS - NO COLORS
        async function populateItems(categoryId) {
            const tableBody = document.getElementById('items-table-body');
            const tableHead = document.getElementById('items-table-head');
            if (!tableBody || !tableHead) return;

            tableBody.innerHTML = '<tr><td colspan="10" class="p-2 text-center text-sm">Loading items...</td></tr>';

            try {
                const items = await fetchItems(categoryId);

                if (items.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="10" class="p-2 text-center text-gray-500 text-sm">No items found in this category</td></tr>';
                    return;
                }

                //  STEP 2: Get category properties (FIXED METHOD)
                let categoryProperties = [];

                if (selectedCategory && selectedCategory.properties && Array.isArray(selectedCategory.properties)) {
                    categoryProperties = selectedCategory.properties;
                    console.log(' Using category properties:', categoryProperties);
                } else {
                    //  Fallback: Extract unique properties from items
                    const allProperties = new Set();
                    items.forEach(item => {
                        if (item.property_values && Array.isArray(item.property_values)) {
                            item.property_values.forEach(pv => {
                                if (pv.propertyName) {
                                    allProperties.add(pv.propertyName);
                                }
                            });
                        }
                        // Also check old 'property' field format
                        if (item.property && typeof item.property === 'string') {
                            const pairs = item.property.split(',');
                            pairs.forEach(pair => {
                                const [prop] = pair.split(':');
                                if (prop && prop.trim()) {
                                    allProperties.add(prop.trim());
                                }
                            });
                        }
                    });
                    categoryProperties = Array.from(allProperties);
                    console.log(' Extracted properties from items:', categoryProperties);
                }

                //  STEP 3: Build dynamic table header
                let headerHTML = `
            <th class="p-2 text-left border bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs font-bold">
                <i data-lucide="image" class="w-3 h-3 inline mr-1"></i>Image
            </th>
            <th class="p-2 text-left border bg-gradient-to-r from-blue-500 to-blue-600 text-white text-xs font-bold">
                <i data-lucide="package" class="w-3 h-3 inline mr-1"></i>Name
            </th>
        `;

                //  Add property columns with simple styling
                categoryProperties.forEach((prop) => {
                    headerHTML += `
                <th class="p-2 text-left border bg-gradient-to-r from-gray-500 to-gray-600 text-white text-xs font-bold">
                    <i data-lucide="settings" class="w-3 h-3 inline mr-1"></i>${prop}
                </th>
            `;
                });

                headerHTML += `
            <th class="p-2 text-left border bg-gradient-to-r from-indigo-500 to-indigo-600 text-white text-xs font-bold">
                <i data-lucide="check-circle" class="w-3 h-3 inline mr-1"></i>Available
            </th>
            <th class="p-2 text-left border bg-gradient-to-r from-red-500 to-red-600 text-white text-xs font-bold">
                <i data-lucide="zap" class="w-3 h-3 inline mr-1"></i>Actions
            </th>
        `;

                const headerRow = tableHead.querySelector('tr');
                headerRow.innerHTML = headerHTML;

                //  STEP 4: Build table body with SIMPLE NUMBERS
                tableBody.innerHTML = '';

                items.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-blue-50 cursor-pointer transition-all duration-200 hover:shadow-sm';

                    //  Image column
                                    const imageHTML = item.image ?
                        `<img src="${item.image}" class="w-10 h-10 object-cover rounded-lg border-2 border-gray-200" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"><div class="text-2xl text-center hidden">🔌</div>` :
                        '<div class="text-2xl text-center">🔌</div>';

                    //  Get property values for this item (ENHANCED METHOD)
                    const itemProperties = {};

                    // Method 1: From property_values array (new format)
                    if (item.property_values && Array.isArray(item.property_values)) {
                        item.property_values.forEach(pv => {
                            if (pv.propertyName && pv.value) {
                                itemProperties[pv.propertyName] = pv.value;
                            }
                        });
                    }

                    // Method 2: From property string (old format) - as fallback
                    if (item.property && typeof item.property === 'string') {
                        const pairs = item.property.split(',');
                        pairs.forEach(pair => {
                            const [prop, val] = pair.split(':');
                            if (prop && val) {
                                const propName = prop.trim();
                                const propValue = val.trim();
                                if (!itemProperties[propName]) { // Don't overwrite new format
                                    itemProperties[propName] = propValue;
                                }
                            }
                        });
                    }

                    //  Build property columns with SIMPLE NUMBERS - NO BACKGROUND COLORS
                    let propertyColumnsHTML = '';
                    categoryProperties.forEach((prop) => {
                        const value = itemProperties[prop] || '-';

                        propertyColumnsHTML += `
                    <td class="p-2 border text-center">
                        <span class="simple-number">
                            ${value}
                        </span>
                    </td>
                `;
                    });

                    //  Available status with simple styling
                    const availableStatus = item.available <= 0 ?
                        '<span class="bg-red-500 text-white px-2 py-1 rounded-full text-xs font-bold">OUT OF STOCK</span>' :
                        item.available <= 5 ?
                            `<span class="bg-orange-500 text-white px-2 py-1 rounded-full text-xs font-bold">${item.available} (Low)</span>` :
                            `<span class="simple-number">${item.available}</span>`;

                    //  Build complete row
                    row.innerHTML = `
                <td class="p-2 border text-center">${imageHTML}</td>
                <td class="p-2 border">
                    <div class="font-bold text-blue-700 text-sm">${item.name}</div>
                    <div class="text-xs text-gray-500">Total: ${item.total}</div>
                </td>
                ${propertyColumnsHTML}
                <td class="p-2 border text-center">${availableStatus}</td>
                <td class="p-2 border">
                    <div class="flex gap-1 justify-center">
                        <button onclick="event.stopPropagation(); showItemDetail(${JSON.stringify(item).replace(/"/g, '&quot;')})" 
                                class="bg-blue-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-blue-600 transition-colors"
                                title="Issue Item">
                            <i data-lucide="zap" class="w-3 h-3"></i>
                        </button>
                        <button onclick="event.stopPropagation(); editItem(${item.id})" 
                                class="bg-green-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-green-600 transition-colors"
                                title="Edit">
                            <i data-lucide="edit" class="w-3 h-3"></i>
                        </button>
                        <button onclick="event.stopPropagation(); deleteItem(${item.id})" 
                                class="bg-red-500 text-white px-2 py-1 rounded-lg text-xs hover:bg-red-600 transition-colors"
                                title="Delete">
                            <i data-lucide="trash-2" class="w-3 h-3"></i>
                        </button>
                    </div>
                </td>
            `;

                    //  Row click handler
                    row.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) {
                            selectedItem = item;
                            showItemDetail(item);
                        }
                    });

                    tableBody.appendChild(row);
                });

                lucide.createIcons();

                console.log(` Table generated with ${categoryProperties.length} property columns:`, categoryProperties);

            } catch (error) {
                console.error(' Error in populateItems:', error);
                tableBody.innerHTML = '<tr><td colspan="10" class="p-2 text-center text-red-500 text-sm">Error loading items</td></tr>';
                showToast('Error loading items', 'error');
            }
        }

        //  FIXED: Populate Current Issues Table
        //  COMPLETE FIXED: Populate Current Issues Table (केवल issued items)
        async function populateCurrentIssuesTable() {
            const tbody = document.getElementById('current-issues-table');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center">Loading...</td></tr>';

            try {
                const currentIssues = await fetchCurrentIssues();
                tbody.innerHTML = '';

                if (currentIssues.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-gray-500">No currently issued items</td></tr>';
                    return;
                }

                currentIssues.forEach(issued => {
                    const row = document.createElement('tr');
                    row.className = 'border-t';  //  Simple styling (no permanent check needed)
                    
                    const issueDate = new Date(issued.issued_date).toLocaleDateString('en-US');

                    const itemImage = issued.items?.image ?
                        createImagePreview(issued.items.image, 'small') :
                        '<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 text-gray-400"></i></div>';

                    const memberPhoto = issued.members?.photo ?
                        createImagePreview(issued.members.photo, 'small', true) :
                        '<div class="profile-image bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-6 h-6 text-gray-400"></i></div>';

                    // ✅ Simple action button (केवल return button - no permanent check)
                    const actionButton = `<button onclick="smartReturn(${issued.member_id}, '${issued.members?.name || 'Unknown'}')" class="bg-blue-500 text-white px-3 py-1 rounded text-sm hover:bg-blue-600">Return</button>`;

                    row.innerHTML = `
                        <td class="p-3">${itemImage}</td>
                        <td class="p-3">${issued.items?.name || 'Unknown'}</td>
                        <td class="p-3">${issued.members?.name || 'Unknown'}</td>
                        <td class="p-3">${memberPhoto}</td>
                        <td class="p-3">${issued.members?.branch || 'Unknown'}</td>
                        <td class="p-3">${issued.quantity}</td>
                        <td class="p-3">${issueDate}</td>
                        <td class="p-3">${actionButton}</td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populateCurrentIssuesTable:', error);
                tbody.innerHTML = '<tr><td colspan="8" class="p-3 text-center text-red-500">Error loading current issues</td></tr>';
                showToast('Error loading current issues', 'error');
            }
        }

        // Populate History Table
        async function populateHistoryTable() {
            const tbody = document.getElementById('history-table');
            if (!tbody) return;

            tbody.innerHTML = '<tr><td colspan="9" class="p-3 text-center">Loading...</td></tr>';

            try {
                const history = await fetchHistory();
                tbody.innerHTML = '';

                if (history.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" class="p-3 text-center text-gray-500">No returned items found</td></tr>';
                    return;
                }

                history.forEach(issued => {
                    const row = document.createElement('tr');
                    row.className = 'border-t';
                    const issueDate = new Date(issued.issued_date).toLocaleDateString('en-US');
                    const returnDate = new Date(issued.returned_date).toLocaleDateString('en-US');

                    const issueDateObj = new Date(issued.issued_date);
                    const returnDateObj = new Date(issued.returned_date);
                    const diffTime = Math.abs(returnDateObj - issueDateObj);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    const itemImage = issued.items?.image ?
                        createImagePreview(issued.items.image, 'small') :
                        '<div class="w-12 h-12 bg-gray-200 rounded flex items-center justify-center"><i data-lucide="package" class="w-6 h-6 text-gray-400"></i></div>';

                    const memberPhoto = issued.members?.photo ?
                        createImagePreview(issued.members.photo, 'small', true) :
                        '<div class="profile-image bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-6 h-6 text-gray-400"></i></div>';

                    row.innerHTML = `
                        <td class="p-3">${itemImage}</td>
                        <td class="p-3">${issued.items?.name || 'Unknown'}</td>
                        <td class="p-3">${issued.members?.name || 'Unknown'}</td>
                        <td class="p-3">${memberPhoto}</td>
                        <td class="p-3">${issued.members?.branch || 'Unknown'}</td>
                        <td class="p-3">${issued.quantity}</td>
                        <td class="p-3">${issueDate}</td>
                        <td class="p-3">${returnDate}</td>
                        <td class="p-3"><span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs">${diffDays} days</span></td>
                    `;
                    tbody.appendChild(row);
                });

                lucide.createIcons();

            } catch (error) {
                console.error('Error in populateHistoryTable:', error);
                tbody.innerHTML = '<tr><td colspan="9" class="p-3 text-center text-red-500">Error loading history</td></tr>';
                showToast('Error loading history', 'error');
            }
        }

        // Search Functions
        const searchMembers = () => {
            const term = document.getElementById('search-members').value.toLowerCase();
            const rows = document.querySelectorAll('#members-table-body tr');
            rows.forEach(row => {
                if (row.cells.length < 2) return;
                const name = row.cells[1].textContent.toLowerCase();
                const branch = row.cells[3].textContent.toLowerCase();
                row.style.display = (name.includes(term) || branch.includes(term)) ? '' : 'none';
            });
        };

        const searchIssues = () => {
            const term = document.getElementById('search-issues').value.toLowerCase();
            const rows = document.querySelectorAll('#current-issues-table tr');
            rows.forEach(row => {
                if (row.cells.length < 3) return;
                const item = row.cells[1].textContent.toLowerCase();
                const member = row.cells[2].textContent.toLowerCase();
                row.style.display = (item.includes(term) || member.includes(term)) ? '' : 'none';
            });
        };

        const filterIssueMembers = () => {
            const term = document.getElementById('search-issue-members').value.toLowerCase();
            const select = document.getElementById('issue-member');
            const options = select.querySelectorAll('option');
            options.forEach(opt => {
                if (opt.value === '') return;
                opt.style.display = opt.textContent.toLowerCase().includes(term) ? '' : 'none';
            });
        };

        function showCategoriesView() {
            const categoriesView = document.getElementById('categories-view');
            const itemsView = document.getElementById('items-view');
            const itemDetailView = document.getElementById('item-detail-view');

            if (categoriesView) categoriesView.classList.remove('hidden');
            if (itemsView) itemsView.classList.add('hidden');
            if (itemDetailView) itemDetailView.classList.add('hidden');

            selectedCategory = null;
            selectedItem = null;
        }

        function showItemsView(category) {
            selectedCategory = category;

            const categoriesView = document.getElementById('categories-view');
            const itemsView = document.getElementById('items-view');
            const itemDetailView = document.getElementById('item-detail-view');

            if (categoriesView) categoriesView.classList.add('hidden');
            if (itemsView) itemsView.classList.remove('hidden');
            if (itemDetailView) itemDetailView.classList.add('hidden');

            if (category) {
                const categoryTitle = document.getElementById('category-title');
                if (categoryTitle) categoryTitle.textContent = category.name;
                populateItems(category.id);
            }
        }

        async function showItemDetail(item) {
            selectedItem = item;

            const categoriesView = document.getElementById('categories-view');
            const itemsView = document.getElementById('items-view');
            const itemDetailView = document.getElementById('item-detail-view');

            if (categoriesView) categoriesView.classList.add('hidden');
            if (itemsView) itemsView.classList.add('hidden');
            if (itemDetailView) itemDetailView.classList.remove('hidden');

            const itemNameEl = document.getElementById('item-name');
            const itemAvailableEl = document.getElementById('item-available');
            const itemTotalEl = document.getElementById('item-total');
            const itemPropertyEl = document.getElementById('item-property');

            if (itemNameEl) itemNameEl.textContent = item.name;
            if (itemAvailableEl) itemAvailableEl.textContent = item.available;
            if (itemTotalEl) itemTotalEl.textContent = item.total;
            if (itemPropertyEl) itemPropertyEl.textContent = item.property || 'Not specified';

            const imageContainer = document.getElementById('item-image-container');
            if (imageContainer) {
                if (item.image) {
                    imageContainer.innerHTML = `<img src="${item.image}" class="w-full h-full object-cover rounded-lg" onerror="this.style.display='none'">`;
                } else {
                    imageContainer.innerHTML = '<span class="text-6xl">🔌</span>';
                }
            }

            try {
                const { data: issuedItems } = await supabaseClient
                    .from('issued_items')
                    .select(`
                        *,
                        members(name, branch)
                    `)
                    .eq('item_id', item.id)
                    .eq('status', 'issued');

                const issuedList = document.getElementById('issued-list');
                if (issuedList) {
                    issuedList.innerHTML = '';

                    if (issuedItems && issuedItems.length > 0) {
                        issuedItems.forEach(issued => {
                            const issueDiv = document.createElement('div');
                            issueDiv.className = 'flex justify-between items-center p-2 bg-gray-50 rounded';
                            issueDiv.innerHTML = `
                                <div>
                                    <p class="font-medium">${issued.members.name}</p>
                                    <p class="text-sm text-gray-500">${issued.members.branch}</p>
                                </div>
                                <div class="text-right">
                                    <p class="font-semibold">Qty: ${issued.quantity}</p>
                                    <button onclick="returnItem(${issued.id}, ${issued.quantity})" class="text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600">
                                        Return
                                    </button>
                                </div>
                            `;
                            issuedList.appendChild(issueDiv);
                        });
                    } else {
                        issuedList.innerHTML = '<p class="text-gray-500 text-center py-4">No items currently issued</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading issued items:', error);
                const issuedList = document.getElementById('issued-list');
                if (issuedList) {
                    issuedList.innerHTML = '<p class="text-red-500 text-center py-4">Error loading issued items</p>';
                }
            }
        }

        async function openDialog(type) {
            const dialog = document.getElementById('dialog-backdrop');
            const title = document.getElementById('dialog-title');
            const content = document.getElementById('dialog-content');

            if (!dialog || !title || !content) return;

            dialog.classList.remove('hidden');

            if (type === 'addMember') {
                title.textContent = 'Add New Member';
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <label for="member-photo-input" class="image-upload-area w-24 h-24 mx-auto rounded-full overflow-hidden border-2 flex items-center justify-center bg-gray-50 cursor-pointer">
                                <img id="member-photo-preview" src="data:," class="w-full h-full object-cover hidden">
                                <div id="member-photo-placeholder" class="text-center">
                                    <i data-lucide="camera" class="w-8 h-8 mx-auto text-gray-400 mb-1"></i>
                                    <p class="text-xs text-gray-500">Add Photo</p>
                                </div>
                            </label>
                            <input type="file" id="member-photo-input" accept="image/*" class="hidden" onchange="handleMemberPhoto(this)">
                        </div>
                        <input type="text" placeholder="Name" id="member-name" class="w-full p-2 border rounded" required />
                        <input type="text" placeholder="Batch (e.g., 2023)" id="member-batch" class="w-full p-2 border rounded" required />
                        <input type="text" placeholder="Branch (e.g., CSE)" id="member-branch" class="w-full p-2 border rounded" required />
                        <input type="text" placeholder="Year (e.g., 2nd)" id="member-year" class="w-full p-2 border rounded" required />
                        <input type="tel" placeholder="Contact (10 digits)" id="member-contact" class="w-full p-2 border rounded" required />
                        <textarea placeholder="Address" id="member-address" class="w-full p-2 border rounded" rows="3"></textarea>
                        <button onclick="addMember()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                            Add Member
                        </button>
                    </div>
                `;
            } else if (type === 'addCategory') {
                title.textContent = 'Add New Category';
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <label for="category-image-input" class="image-upload-area w-20 h-20 mx-auto rounded-lg overflow-hidden border-2 flex items-center justify-center bg-gray-50 cursor-pointer">
                                <img id="category-image-preview" src="data:," class="w-full h-full object-cover hidden">
                                <div id="category-image-placeholder" class="text-center">
                                    <div class="text-2xl mb-1"> </div>
                                    <p class="text-xs text-gray-500">Add Icon</p>
                                </div>
                            </label>
                            <input type="file" id="category-image-input" accept="image/*" class="hidden" onchange="handleCategoryImage(this)">
                        </div>
                        <input type="text" placeholder="Category Name" id="category-name" class="w-full p-2 border rounded" required />
                        <textarea placeholder="Description (optional)" id="category-description" class="w-full p-2 border rounded" rows="3"></textarea>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Properties:</label>
                            <div id="properties-list" class="space-y-2">
                                <div class="flex items-center gap-2">
                                    <input type="text" class="property-input flex-1 p-2 border rounded" placeholder="Property name (e.g., Voltage)">
                                    <button type="button" onclick="removePropertyInput(this)" class="property-remove-btn">×</button>
                                </div>
                            </div>
                            <button type="button" onclick="addPropertyInput('properties-list')" class="mt-2 text-blue-500 hover:underline text-sm">+ Add Property</button>
                        </div>
                        
                        <p class="text-sm text-gray-500">Category Type: <strong>${activeTab === 'consumable' ? 'Consumable' : 'Non-Consumable'}</strong></p>
                        <button onclick="addCategory()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                            Add Category
                        </button>
                    </div>
                `;
            } else if (type === 'addItem') {
                title.textContent = 'Add New Item';

                let categoryPropertiesHTML = '';
                if (selectedCategory && selectedCategory.properties && selectedCategory.properties.length > 0) {
                    categoryPropertiesHTML = selectedCategory.properties.map(prop => `
                        <div class="flex items-center gap-2 bg-blue-50 p-2 rounded border property-value-row">
                            <label class="w-24 text-sm font-medium">${prop}:</label>
                            <input type="text" 
                                   class="item-property-value flex-1 p-2 border rounded" 
                                   data-property-name="${prop}" 
                                   placeholder="Enter ${prop} value (e.g., 10k, 5V)">
                            <button type="button" onclick="removePropertyValueRow(this)" class="text-red-500 hover:bg-red-100 p-1 rounded" title="Remove">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `).join('');
                }

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <label for="item-image-input" class="image-upload-area w-24 h-24 mx-auto rounded-lg overflow-hidden border-2 flex items-center justify-center bg-gray-50 cursor-pointer">
                                <img id="item-image-preview" src="data:," class="w-full h-full object-cover hidden">
                                <div id="item-image-placeholder" class="text-center">
                                    <i data-lucide="image" class="w-8 h-8 mx-auto text-gray-400 mb-1"></i>
                                    <p class="text-xs text-gray-500">Add Image</p>
                                </div>
                            </label>
                            <input type="file" id="item-image-input" accept="image/*" class="hidden" onchange="handleItemImage(this)">
                        </div>
                        <input type="text" placeholder="Item Name" id="item-name" class="w-full p-2 border rounded" required />
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Property Values:</label>
                            <div id="item-property-values-list" class="space-y-2">
                                ${categoryPropertiesHTML}
                            </div>
                            <button type="button" onclick="addCustomPropertyValue()" class="mt-2 text-blue-500 hover:underline text-sm">+ Add Custom Property</button>
                        </div>
                        
                        <input type="number" placeholder="Total Quantity" id="item-total" class="w-full p-2 border rounded" min="1" required />
                        <p class="text-sm text-gray-500">Category: <strong>${selectedCategory ? selectedCategory.name : ''}</strong></p>
                        <button onclick="addItem()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                            Add Item
                        </button>
                    </div>
                `;

            } else if (type === 'issueItem') {
                try {
                    const members = await fetchMembers();
                    title.textContent = 'Issue Item';
                    content.innerHTML = `
                        <div class="space-y-4">
                            <input type="text" placeholder="Search members..." id="search-issue-members" class="w-full p-2 border rounded" oninput="filterIssueMembers()">
                            <select id="issue-member" class="w-full p-2 border rounded" required>
                                <option value="">Select Member</option>
                                ${members.map(member => `<option value="${member.id}">${member.name} (${member.branch})</option>`).join('')}
                            </select>
                            <input type="number" placeholder="Quantity" id="issue-quantity" class="w-full p-2 border rounded" min="1" max="${selectedItem ? selectedItem.available : 0}" required />
                            
                            <!--  NEW: Permanent Issue Option -->
                            <div class="flex items-center gap-2 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                <input type="checkbox" id="permanent-issue" class="rounded">
                                <label for="permanent-issue" class="text-sm text-orange-800">
                                    <strong> Permanent Issue</strong> (Item will not be returned & quantity will be deducted permanently)
                                </label>
                            </div>
                            
                            <p class="text-sm text-gray-500">Available: ${selectedItem ? selectedItem.available : 0}</p>
                            <button onclick="issueItem()" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                                Issue Item
                            </button>
                        </div>
                    `;
                } catch (error) {
                    console.error('Error loading members for issue dialog:', error);
                    content.innerHTML = '<div class="text-center text-red-500">Error loading members</div>';
                }
            } else if (type === 'itemReference') {
                //  NEW: Item Reference Dialog
                title.textContent = 'Component Reference Guide';
                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-blue-800 mb-2"> Reference Information</h4>
                            <p class="text-sm text-blue-700">Quick reference for common electronic components and their specifications.</p>
                        </div>
                        
                        <div class="grid gap-4">
                            <div class="border rounded p-3">
                                <h5 class="font-semibold mb-2">🔌 Resistors</h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Common Values:</strong> 1K, 2.2K, 4.7K, 10K, 22K, 47K, 100K</p>
                                    <p><strong>Power Rating:</strong> 1/4W, 1/2W, 1W, 2W</p>
                                    <p><strong>Tolerance:</strong> ±5%, ±1%</p>
                                </div>
                            </div>
                            
                            <div class="border rounded p-3">
                                <h5 class="font-semibold mb-2"> Capacitors</h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Ceramic:</strong> 10pF - 10µF</p>
                                    <p><strong>Electrolytic:</strong> 1µF - 10000µF</p>
                                    <p><strong>Voltage:</strong> 6.3V, 16V, 25V, 50V, 100V</p>
                                </div>
                            </div>
                            
                            <div class="border rounded p-3">
                                <h5 class="font-semibold mb-2">🔌 LEDs</h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Colors:</strong> Red, Green, Blue, Yellow, White</p>
                                    <p><strong>Forward Voltage:</strong> 1.8V-3.3V</p>
                                    <p><strong>Current:</strong> 20mA typical</p>
                                </div>
                            </div>
                            
                            <div class="border rounded p-3">
                                <h5 class="font-semibold mb-2"> ICs</h5>
                                <div class="text-sm space-y-1">
                                    <p><strong>Op-Amps:</strong> LM358, LM741, TL072</p>
                                    <p><strong>Logic:</strong> 74HC00, 74HC04, 74HC74</p>
                                    <p><strong>Regulators:</strong> 7805, 7812, LM317</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 p-3 rounded">
                            <p class="text-xs text-yellow-800">
                                <strong> Tip:</strong> Always check component datasheets for exact specifications before use.
                            </p>
                        </div>
                        
                        <button onclick="closeDialog()" class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600">
                            Close Reference
                        </button>
                    </div>
                `;
            }

            lucide.createIcons();
        }

        function closeDialog() {
            const dialog = document.getElementById('dialog-backdrop');
            if (dialog) {
                dialog.classList.add('hidden');
            }
        }

        function setupNavigationListeners() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = btn.dataset.section;
                    if (section && section !== activeSection) {
                        setActiveSection(section);
                    }
                });
            });

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const tab = btn.dataset.tab;
                    if (tab && tab !== activeTab) {
                        setActiveTab(tab);
                    }
                });
            });
        }

        //  ENHANCED SEARCH FUNCTIONS FOR BETTER UX
        async function searchItemsByProperty(searchTerm) {
            try {
                const { data: items, error } = await supabaseClient
                    .from('items')
                    .select(`
                        *,
                        categories(name)
                    `);

                if (error) throw error;

                return items.filter(item => {
                    // Search in item name
                    if (item.name.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return true;
                    }

                    // Search in property string
                    if (item.property && item.property.toLowerCase().includes(searchTerm.toLowerCase())) {
                        return true;
                    }

                    // Search in property values array
                    if (item.property_values && Array.isArray(item.property_values)) {
                        return item.property_values.some(pv =>
                            (pv.propertyName && pv.propertyName.toLowerCase().includes(searchTerm.toLowerCase())) ||
                            (pv.value && pv.value.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                    }

                    return false;
                }) || [];

            } catch (error) {
                console.error('Error searching items:', error);
                return [];
            }
        }

        // Enhanced Category Search
        async function searchCategories() {
            const term = document.getElementById('search-categories').value.toLowerCase().trim();

            if (!term) {
                populateCategories();
                return;
            }

            const cards = document.querySelectorAll('#categories-grid > div');
            let hasVisibleCards = false;

            // Remove existing search indicators
            document.querySelectorAll('.search-indicator').forEach(indicator => {
                indicator.remove();
            });

            cards.forEach(card => {
                const title = card.querySelector('h3')?.textContent.toLowerCase();
                const description = card.querySelector('p')?.textContent.toLowerCase();

                let shouldShow = false;

                if (title?.includes(term) || description?.includes(term)) {
                    shouldShow = true;
                }

                if (shouldShow) {
                    card.style.display = 'block';
                    hasVisibleCards = true;
                } else {
                    card.style.display = 'none';
                }
            });

            if (!hasVisibleCards) {
                await searchInItemsForCategories(term);
            }
        }

        // Search Items to Find Relevant Categories
        async function searchInItemsForCategories(searchTerm) {
            try {
                const matchingItems = await searchItemsByProperty(searchTerm);
                const categoryIds = [...new Set(matchingItems.map(item => item.category_id))];

                const cards = document.querySelectorAll('#categories-grid > div');
                let hasResults = false;

                cards.forEach(card => {
                    const categoryData = card.querySelector('[onclick*="showItemsView"]');
                    if (categoryData) {
                        const categoryInfo = JSON.parse(categoryData.getAttribute('onclick').match(/showItemsView\((.*?)\)/)[1].replace(/&quot;/g, '"'));

                        if (categoryIds.includes(categoryInfo.id)) {
                            card.style.display = 'block';
                            hasResults = true;

                            // Add search indicator
                            if (!card.querySelector('.search-indicator')) {
                                const indicator = document.createElement('div');
                                indicator.className = 'search-indicator absolute top-0 left-0 bg-yellow-400 text-black text-xs px-2 py-1 rounded-br-lg';
                                indicator.innerHTML = `<i data-lucide="search" class="w-3 h-3 inline mr-1"></i>Match`;
                                card.style.position = 'relative';
                                card.appendChild(indicator);
                            }
                        } else {
                            card.style.display = 'none';
                        }
                    }
                });

                if (!hasResults) {
                    const grid = document.getElementById('categories-grid');
                    grid.innerHTML = `
                        <div class="col-span-full text-center p-8">
                            <div class="text-6xl mb-4"></div>
                            <h3 class="text-xl font-semibold text-gray-600 mb-2">No Categories Found</h3>
                            <p class="text-gray-500">No categories contain items matching "${searchTerm}"</p>
                            <button onclick="populateCategories()" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                Show All Categories
                            </button>
                        </div>
                    `;
                }

                lucide.createIcons();
            } catch (error) {
                console.error('Error searching in items for categories:', error);
            }
        }

        //  EDIT CATEGORY FUNCTION
        async function editCategory(categoryId) {
            try {
                const { data, error } = await supabaseClient
                    .from('categories')
                    .select('*')
                    .eq('id', categoryId)
                    .single();

                if (error) throw error;

                openDialog('editCategory');
                document.getElementById('dialog-title').textContent = 'Edit Category';
                const content = document.getElementById('dialog-content');

                let propertiesHTML = '';
                if (data.properties && data.properties.length > 0) {
                    propertiesHTML = data.properties.map(prop => `
                        <div class="flex items-center gap-2">
                            <input type="text" class="property-input flex-1 p-2 border rounded" value="${prop}" placeholder="Property name">
                            <button type="button" onclick="removePropertyInput(this)" class="property-remove-btn">×</button>
                        </div>
                    `).join('');
                } else {
                    propertiesHTML = `
                        <div class="flex items-center gap-2">
                            <input type="text" class="property-input flex-1 p-2 border rounded" placeholder="Property name">
                            <button type="button" onclick="removePropertyInput(this)" class="property-remove-btn">×</button>
                        </div>
                    `;
                }

                content.innerHTML = `
                    <div class="space-y-4">
                        <div class="text-center">
                            <label for="edit-category-image-input" class="image-upload-area w-20 h-20 mx-auto rounded-lg overflow-hidden border-2 flex items-center justify-center bg-gray-50 cursor-pointer">
                                <img id="edit-category-image-preview" src="${data.image || 'data:,'}" class="w-full h-full object-cover ${data.image ? '' : 'hidden'}">
                                <div id="edit-category-image-placeholder" class="text-center ${data.image ? 'hidden' : ''}">
                                    <div class="text-2xl mb-1"> </div>
                                    <p class="text-xs text-gray-500">Change Icon</p>
                                </div>
                            </label>
                            <input type="file" id="edit-category-image-input" accept="image/*" class="hidden" onchange="handleCategoryImage(this, 'edit')">
                        </div>
                        <input type="text" value="${data.name}" placeholder="Category Name" id="edit-category-name" class="w-full p-2 border rounded" required />
                        <textarea placeholder="Description (optional)" id="edit-category-description" class="w-full p-2 border rounded" rows="3">${data.description || ''}</textarea>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Properties:</label>
                            <div id="edit-properties-list" class="space-y-2">
                                ${propertiesHTML}
                            </div>
                            <button type="button" onclick="addPropertyInput('edit-properties-list')" class="mt-2 text-blue-500 hover:underline text-sm">+ Add Property</button>
                        </div>
                        
                        <button onclick="updateCategory(${categoryId})" class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600">
                            Update Category
                        </button>
                    </div>
                `;

                lucide.createIcons();

            } catch (error) {
                console.error('Error loading category for edit:', error);
                showToast('Error loading category for edit', 'error');
            }
        }

        //  FIXED: Init Function with Real-time Subscriptions
        async function init() {
            if (isInitialized) return;
            isInitialized = true;

            try {
                console.log(' Initializing ENHANCED inventory system...');
                lucide.createIcons();
                setupNavigationListeners();

                // Setup real-time immediately
                await setupRealtimeSubscriptions();

                setActiveSection('dashboard');
                await updateStats(); // Initial stats load

                // AUTOMATIC CALCULATION FIX ON STARTUP
                console.log(' Running automatic calculation fix...');
                setTimeout(async () => {
                    await fixItemCalculations();
                }, 2000); // Wait 2 seconds after app loads

                if (!authListenerSetup) {
                    authListenerSetup = true;
                    supabaseClient.auth.onAuthStateChange(async (event, session) => {
                        console.log(`Auth state changed: ${event}`);
                        if (event === 'SIGNED_IN' && !currentUser) {
                            currentUser = session.user;
                            showMainApp();
                            await setupRealtimeSubscriptions();
                            await updateStats();
                        } else if (event === 'SIGNED_OUT') {
                            currentUser = null;
                            isInitialized = false;
                            authListenerSetup = false;
                            cleanupSubscriptions();
                            showAuthModal();
                        }
                    });
                }

                console.log(' ENHANCED System initialized successfully with all features!');
                addAuditEntry('system', 'System initialized successfully');

            } catch (error) {
                console.error(' Error initializing app:', error);
                isInitialized = false;
                showToast('App initialization error', 'error');
            }
        }

        // Page Load Handler
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                lucide.createIcons();
                showSplashAndInit();
            });
        } else {
            lucide.createIcons();
            showSplashAndInit();
        }
    </script>

    <!-- ✅ PWA SERVICE WORKER -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(() => {
                        console.log(' PWA Ready! App can be installed');
                    })
                    .catch((error) => {
                        console.log(' PWA registration failed:', error);
                    });
            });
        }
    </script>
</body>

</html>

